<!DOCTYPE html>
<html>
<head>
  <title>灌溉工具合集（开关式喷头切换·修复版）</title>
  <link rel="icon" href="favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Microsoft YaHei", Arial, sans-serif;
      -webkit-tap-highlight-color: transparent; /* 移除点击高亮 */
      -webkit-touch-callout: none; /* 禁用长按菜单 */
    }
    html, body {
      overscroll-behavior: none; /* 关键！禁用下拉刷新 */
      -webkit-overflow-scrolling: auto;
      touch-action: none; /* 禁用所有触摸手势 */
      overflow: hidden; /* 防止滚动 */
      position: fixed;
      width: 100%;
      height: 100%;
      background: #f5f5f5;
    }
    
    /* 允许内容区域滚动 */
    body {
      overflow-y: auto; /* 允许垂直滚动 */
      touch-action: pan-y; /* 只允许垂直平移 */
      -webkit-overflow-scrolling: touch;
      padding: 15px;
    }
    
    /* 禁用双击缩放 */
    * {
      touch-action: manipulation;
    }
    
    .header {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 15px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .title {
      text-align: center;
      color: #2c3e50;
      font-size: 20px;
      margin-bottom: 15px;
      font-weight: bold;
    }
    .control-group {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }
    .share-input {
      padding: 10px 15px;
      font-size: 14px;
      width: 140px;
      border: 1px solid #ddd;
      border-radius: 6px;
      outline: none;
      touch-action: manipulation;
    }
    .share-input:focus {
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52,152,219,0.1);
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      touch-action: manipulation;
      user-select: none;
    }
    .calc-btn {
      background: #27ae60;
      color: white;
    }
    .calc-btn:hover, .calc-btn:active {
      background: #219a52;
      box-shadow: 0 2px 4px rgba(39,174,96,0.3);
    }
    .tab-btn {
      background: #3498db;
      color: white;
    }
    .tab-btn:hover, .tab-btn.active, .tab-btn:active {
      background: #2980b9;
      box-shadow: 0 2px 4px rgba(52,152,219,0.3);
    }
    /* 开关样式 */
    .switch-container {
      display: flex;
      align-items: center;
      gap: 10px;
      touch-action: manipulation;
      user-select: none;
    }
    .switch-label {
      font-size: 14px;
      color: #34495e;
      font-weight: 500;
    }
    .switch {
      position: relative;
      width: 60px;
      height: 30px;
      background: #ddd;
      border-radius: 15px;
      cursor: pointer;
      transition: background 0.3s;
      touch-action: manipulation;
    }
    .switch::after {
      content: '';
      position: absolute;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: left 0.3s;
    }
    .switch.active {
      background: #9b59b6;
    }
    .switch.active::after {
      left: 33px;
    }
    .tool-container {
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      touch-action: none;
    }
    iframe {
      width: 100%;
      height: 80vh;
      border: none;
      display: none;
      border-radius: 8px;
      overflow: hidden;
      touch-action: none;
    }
    iframe.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .tip-text {
      text-align: center;
      color: #7f8c8d;
      font-size: 12px;
      margin-top: 10px;
      padding-bottom: 20px;
    }
  </style>
</head>
<body>
  <!-- 顶部控制区 -->
  <div class="header">
    <div class="title">灌溉工具合集（共享参数+开关式喷头切换）</div>
    <div class="control-group">
      <!-- 共享长宽输入 -->
      <div>
        地块长度(米)：
        <input type="number" id="shareLength" class="share-input" placeholder="例：200" min="1" value="200">
      </div>
      <div>
        地块宽度(米)：
        <input type="number" id="shareWidth" class="share-input" placeholder="例：48" min="1" value="48">
      </div>
      <!-- 开关式喷头切换 -->
      <div class="switch-container" onclick="toggleGunSwitch()">
        <span class="switch-label">四嘴喷头</span>
        <div class="switch" id="gunSwitch"></div>
        <span class="switch-label">防沙喷头</span>
      </div>
      <!-- 同步计算按钮 -->
      <button class="btn calc-btn" onclick="syncAndCalc()">同步参数并计算</button>
    </div>
  </div>
  <!-- 工具切换按钮 -->
  <div class="control-group" style="margin-bottom: 15px;">
    <button class="btn tab-btn active" onclick="showTool('tool1')">水网计算</button>
    <button class="btn tab-btn" onclick="showTool('tool2')">水网画图</button>
    <button class="btn tab-btn" onclick="showTool('tool3')">水泵压力</button>
  </div>
  <!-- 工具容器 -->
  <div class="tool-container">
    <iframe id="tool1" src="1水网计算.html" onload="toolLoaded('tool1')"></iframe>
    <iframe id="tool2" src="2水网画图.html" onload="toolLoaded('tool2')"></iframe>
    <iframe id="tool3" src="3水泵压力.html" onload="toolLoaded('tool3')"></iframe>
  </div>
  <div class="tip-text">共享参数自动同步 | 开关切换喷头类型 | 所有工具同步计算</div>
  
  <script>
    // === 禁用触摸手势 ===
    // 阻止默认触摸行为
    document.addEventListener('touchstart', function(e) {
      if (e.touches.length > 1) {
        e.preventDefault(); // 阻止多点触控
      }
    }, { passive: false });

    // 阻止下拉刷新
    let startY = 0;
    document.addEventListener('touchstart', function(e) {
      startY = e.touches[0].clientY;
    }, { passive: true });

    document.addEventListener('touchmove', function(e) {
      const currentY = e.touches[0].clientY;
      // 如果在页面顶部并且向下滑动，阻止默认行为
      if (window.scrollY === 0 && currentY > startY) {
        e.preventDefault();
      }
      // 阻止缩放
      if (e.scale !== 1) {
        e.preventDefault();
      }
    }, { passive: false });

    // 禁用手势事件
    document.addEventListener('gesturestart', function(e) {
      e.preventDefault();
    });
    document.addEventListener('gesturechange', function(e) {
      e.preventDefault();
    });
    document.addEventListener('gestureend', function(e) {
      e.preventDefault();
    });

    // 禁用双击缩放
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(e) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        e.preventDefault();
      }
      lastTouchEnd = now;
    }, false);

    // === 原有应用逻辑 ===
    const toolLoadedStatus = { tool1: false, tool2: false, tool3: false };
    let currentGunType = "four";
    let isManualSwitch = false;

    function toolLoaded(toolId) {
      toolLoadedStatus[toolId] = true;
      syncGunType(document.getElementById(toolId), currentGunType);
    }

    function showTool(toolId) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      document.querySelectorAll('iframe').forEach(iframe => iframe.classList.remove('active'));
      document.getElementById(toolId).classList.add('active');
    }

    function toggleGunSwitch() {
      isManualSwitch = true;
      
      const switchEl = document.getElementById('gunSwitch');
      const isActive = switchEl.classList.contains('active');
      
      if (isActive) {
        currentGunType = "four";
        switchEl.classList.remove('active');
      } else {
        currentGunType = "sand";
        switchEl.classList.add('active');
      }

      [document.getElementById('tool1'), document.getElementById('tool2'), document.getElementById('tool3')].forEach(iframe => {
        if (toolLoadedStatus[iframe.id]) {
          syncGunType(iframe, currentGunType);
        }
      });
      
      setTimeout(() => {
        isManualSwitch = false;
      }, 500);
    }

    function syncGunType(iframe, gunType) {
      const doc = iframe.contentDocument;
      if (!doc) return;

      if (iframe.id === 'tool1') {
        const nozzleTypeSelect = doc.getElementById('nozzleType');
        if (nozzleTypeSelect) {
          nozzleTypeSelect.value = gunType === "four" ? "four" : "sand";
          nozzleTypeSelect.dispatchEvent(new Event('change'));
          
          if (!isManualSwitch) {
            const calcBtn = doc.getElementById('calcBtn');
            if (calcBtn) setTimeout(() => calcBtn.click(), 100);
          }
        }
      }
      else if (iframe.id === 'tool2') {
        const nozzleTypeSelect = doc.getElementById('nozzleType');
        if (nozzleTypeSelect) {
          nozzleTypeSelect.value = gunType === "four" ? "fourMouth" : "sand";
          nozzleTypeSelect.dispatchEvent(new Event('change'));
          
          const calcBtn = doc.getElementById('generateBtn');
          if (calcBtn) setTimeout(() => calcBtn.click(), 100);
        }
      }
      else if (iframe.id === 'tool3') {
        const gunToggle = doc.getElementById('gunToggle');
        if (gunToggle) {
          const shouldBeActive = gunType === "sand";
          const isActive = gunToggle.classList.contains('active');
          if (shouldBeActive !== isActive) {
            gunToggle.click();
          }
        }
        
        if (!isManualSwitch) {
          const calcBtn = doc.getElementById('calcBtn');
          if (calcBtn) setTimeout(() => calcBtn.click(), 100);
        }
      }
    }

    function syncSingleTool(iframe, length, width) {
      const doc = iframe.contentDocument;
      if (!doc) return;

      const lenInput = doc.getElementById('plotLength');
      if (lenInput) {
        lenInput.value = length;
        lenInput.dispatchEvent(new Event('input'));
        lenInput.dispatchEvent(new Event('change'));
      }

      const widInput = doc.getElementById('plotWidth');
      if (widInput) {
        widInput.value = width;
        widInput.dispatchEvent(new Event('input'));
        widInput.dispatchEvent(new Event('change'));
      }

      const calcBtn = doc.getElementById('calcBtn') || doc.getElementById('generateBtn');
      if (calcBtn) setTimeout(() => calcBtn.click(), 150);
    }

    function syncAndCalc() {
      const length = document.getElementById('shareLength').value.trim();
      const width = document.getElementById('shareWidth').value.trim();
      
      if (!length || !width || isNaN(length) || isNaN(width) || length <=0 || width <=0) {
        alert('请输入有效的正数值！');
        return;
      }

      isManualSwitch = false;
      
      const tools = [document.getElementById('tool1'), document.getElementById('tool2'), document.getElementById('tool3')];
      tools.forEach(iframe => {
        if (toolLoadedStatus[iframe.id]) {
          syncSingleTool(iframe, length, width);
          syncGunType(iframe, currentGunType);
        } else {
          setTimeout(() => {
            syncSingleTool(iframe, length, width);
            syncGunType(iframe, currentGunType);
          }, 300);
        }
      });
    }

    showTool('tool1');
  </script>
</body>
</html>