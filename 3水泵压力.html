<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
    <title>å†œç”°çŒæº‰è®¡ç®—å™¨ï¼ˆé”€å”®ä¸“ç”¨ç‰ˆï¼‰</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{padding:15px;font-family:Arial;font-size:14px;background:#f5f5f5;}
        .box{max-width:650px;margin:0 auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 0 12px rgba(0,0,0,0.15);}
        h1{text-align:center;color:#2c3e50;font-size:18px;margin-bottom:20px;font-weight:bold;}
        .pipe-spec{background:#e8f5e9;border-radius:6px;padding:10px;margin:10px 0;line-height:1.6;color:#2c3e50;font-size:13px;border-left:3px solid #27ae60;}
        .formula-box{background:#f0f8ff;border-radius:6px;padding:10px;margin:10px 0;line-height:1.6;color:#34495e;font-size:13px;border-left:3px solid #3498db;}
        .inp-group{margin-bottom:15px;position:relative;}
        .inp-group label{display:block;margin-bottom:5px;color:#34495e;font-weight:500;}
        .param-tip{font-size:12px;color:#666;margin-top:-3px;margin-bottom:5px;}
        .inp-wrap{display:flex;gap:5px;align-items:center;}
        .inp-wrap input{flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:15px;outline:none;padding-right:10px;}
        .calc-small-btn{width:36px;height:36px;border-radius:6px;background:#3498db;color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;}
        .calc-small-btn:hover{background:#2980b9;}
        .inp-group input.invalid{border-color:#e74c3c;}
        .clear-btn{position:absolute;right:10px;top:32px;cursor:pointer;color:#999;font-size:18px;line-height:32px;width:32px;height:32px;text-align:center;transition:color 0.2s;display:none;user-select:none;}
        .clear-btn:hover{color:#e74c3c;}
        .clear-btn:focus{outline:none;}
        .toggle-group{display:flex;align-items:center;margin:15px 0;gap:10px;}
        .toggle-group label{flex:1;color:#34495e;font-weight:500;}
        .toggle{position:relative;width:50px;height:26px;border-radius:13px;background:#ddd;cursor:pointer;transition:background 0.3s;}
        .toggle::after{content:'';position:absolute;width:22px;height:22px;border-radius:50%;background:#fff;top:2px;left:2px;transition:left 0.3s;}
        .toggle.active{background:#3498db;}
        .toggle.active::after{left:26px;}
        .calc-btn{width:100%;padding:14px;background:#27ae60;color:#fff;border:none;border-radius:6px;font-size:18px;font-weight:bold;cursor:pointer;margin:20px 0 10px;box-shadow:0 2px 4px rgba(39,174,96,0.3);}
        .calc-btn:active{background:#219a52;box-shadow:0 1px 2px rgba(39,174,96,0.3);}
        .advanced-btn{width:auto;padding:6px 12px;background:#eef2f7 !important;color:#4a6fa5 !important;border:none;border-radius:4px;font-size:12px !important;font-weight:normal !important;cursor:pointer;margin:0 0 15px;display:inline-block;}
        .advanced-btn:hover{background:#e1e7f0 !important;}
        .result-card{background:#f8fafc;border-radius:8px;padding:15px;margin-top:15px;}
        .result-card p{color:#34495e;font-size:15px;line-height:1.8;margin:5px 0;}
        .result-card span{color:#e74c3c;font-weight:bold;}
        .result-card .highlight{color:#2980b9;font-weight:bold;margin-bottom:8px;display:inline-block;}
        .limit-alert{background:#fff3e0;border-radius:6px;padding:10px;margin:10px 0;line-height:1.5;color:#e65100;}
        .danger-alert{background:#ffebee;border-radius:6px;padding:10px;margin:10px 0;line-height:1.5;color:#d32f2f;border-left:3px solid #b71c1c;}
        .optimal-alert{background:#e8f5e9;border-radius:6px;padding:10px;margin:10px 0;line-height:1.5;color:#2e7d32;border-left:3px solid #27ae60;}
        .error-text{color:#e74c3c;font-size:12px;margin-top:3px;display:none;}
        .tips{font-size:12px;color:#7f8c8d;margin-top:10px;text-align:center;}
        .advanced-hidden{display:none;margin-top:15px;padding-top:15px;border-top:1px dashed #eee;}
        .result-table{width:100%;border-collapse:collapse;margin:8px 0 15px;}
        .result-table tr{border-bottom:1px solid #eee;}
        .result-table td{padding:6px 0;font-size:15px;}
        .result-table td:last-child{text-align:right;color:#e74c3c;font-weight:bold;}
        .batch-tips{background:#e8f4fd;border-radius:6px;padding:8px;margin-top:10px;font-size:13px;color:#2d6a9f;line-height:1.6;}
        .material-title{font-size:16px;font-weight:bold;color:#2c3e50;margin-top:15px;margin-bottom:8px;}
    </style>
</head>
<body>
    <div class="box">
        <h1>å†œç”°çŒæº‰è®¡ç®—å™¨ï¼ˆé”€å”®ä¸“ç”¨ç‰ˆï¼‰</h1>
        
        <div class="pipe-spec">
            <strong>ğŸ“‹ æ ¸å¿ƒè§„åˆ™ï¼š</strong><br>
            - å•æªç‹¬ç«‹å¼€å…³ï¼Œåˆ†æ‰¹æ¬¡çŒæº‰ï¼Œå§‹ç»ˆå¡åœ¨æ ‡å‡†å‹åŠ›/è¦†ç›–ç›´å¾„<br>
            - å››å˜´å–·å¤´ï¼šæ ‡å‡†å‹åŠ›0.12~0.18MPaï¼Œè¦†ç›–ç›´å¾„16ç±³ï¼Œæµé‡2.5mÂ³/h<br>
            - é˜²æ²™å–·å¤´ï¼šæ ‡å‡†å‹åŠ›0.12~0.18MPaï¼Œè¦†ç›–ç›´å¾„10ç±³ï¼Œæµé‡1.3mÂ³/h<br>
            - ä¸»ç®¡é“é»˜è®¤3å¯¸ï¼ˆ75mmï¼‰ï¼Œæ”¯ç®¡é»˜è®¤2.5å¯¸ï¼ˆ63mmï¼‰
        </div>
        
        <div class="inp-group">
            <label>åœ°å—äº©æ•°</label>
            <div class="inp-wrap">
                <input type="number" id="plotMu" placeholder="ä¾‹å¦‚ï¼š10" min="0.1" step="0.1" value="8.2">
                <button class="calc-small-btn" id="muCalcBtn">â†©ï¸</button>
            </div>
            <div class="error-text" id="muError">è¯·è¾“å…¥å¤§äº0.1çš„æ•°å€¼</div>
        </div>
        <div class="inp-group">
            <label>åœ°å—é•¿åº¦(ç±³)</label>
            <input type="number" id="plotLength" placeholder="ä¾‹å¦‚ï¼š100" min="1" value="110">
            <span class="clear-btn" onclick="clearInput('plotLength')">Ã—</span>
            <div class="error-text" id="lengthError">è¯·è¾“å…¥å¤§äº1çš„æ•°å€¼</div>
        </div>
        <div class="inp-group">
            <label>åœ°å—å®½åº¦(ç±³)</label>
            <input type="number" id="plotWidth" placeholder="ä¾‹å¦‚ï¼š67" min="1" value="50">
            <span class="clear-btn" onclick="clearInput('plotWidth')">Ã—</span>
            <div class="error-text" id="widthError">è¯·è¾“å…¥å¤§äº1çš„æ•°å€¼</div>
        </div>
        
        <div class="toggle-group">
            <label>åˆ‡æ¢ä¸ºé˜²æ²™å–·å¤´ï¼ˆé»˜è®¤å››å˜´å–·å¤´ï¼‰</label>
            <div class="toggle" id="gunToggle"></div>
        </div>
        
        <button class="advanced-btn" id="showAdvBtn">âš™ï¸ å±•å¼€ä¸“ä¸šå‚æ•°</button>
        
        <div class="advanced-hidden" id="advancedParams">
            <div class="inp-group">
                <label>é€‰æ‹©æ°´æ³µåŠŸç‡(kW)</label>
                <select id="pumpPowerSelect">
                    <option value="3">3kW</option>
                    <option value="4">4kW</option>
                    <option value="5.5">5.5kW</option>
                    <option value="7.5" selected>7.5kW</option>
                    <option value="11">11kW</option>
                    <option value="15">15kW</option>
                    <option value="18.5">18.5kW</option>
                    <option value="22">22kW</option>
                    <option value="30">30kW</option>
                    <option value="custom">è‡ªå®šä¹‰åŠŸç‡</option>
                </select>
            </div>
            <div class="inp-group" id="customPowerGroup" style="display:none;">
                <label>è‡ªå®šä¹‰æ°´æ³µåŠŸç‡(kW)</label>
                <input type="number" id="customPower" placeholder="ä¾‹å¦‚ï¼š8" min="1" step="0.5">
                <span class="clear-btn" onclick="clearInput('customPower')">Ã—</span>
                <div class="error-text" id="customPowerError">è¯·è¾“å…¥å¤§äº1çš„æ•°å€¼</div>
            </div>
            
            <div class="inp-group">
                <label>æ°´æ³µé¢å®šæµé‡(mÂ³/h)</label>
                <select id="pumpFlowSelect">
                    <option value="25">25mÂ³/h</option>
                    <option value="38">38mÂ³/h</option>
                    <option value="50">50mÂ³/h</option>
                    <option value="63" selected>63mÂ³/h</option>
                    <option value="88">88mÂ³/h</option>
                    <option value="113">113mÂ³/h</option>
                    <option value="138">138mÂ³/h</option>
                    <option value="163">163mÂ³/h</option>
                    <option value="200">200mÂ³/h</option>
                    <option value="custom">è‡ªå®šä¹‰æµé‡</option>
                </select>
            </div>
            <div class="inp-group" id="customFlowGroup" style="display:none;">
                <label>è‡ªå®šä¹‰é¢å®šæµé‡(mÂ³/h)</label>
                <input type="number" id="customFlow" placeholder="ä¾‹å¦‚ï¼š90" min="5" step="1">
                <span class="clear-btn" onclick="clearInput('customFlow')">Ã—</span>
                <div class="error-text" id="customFlowError">è¯·è¾“å…¥å¤§äº5çš„æ•°å€¼</div>
            </div>

            <!-- ä¼˜åŒ–ï¼šä¸»ç®¡é“é»˜è®¤3å¯¸ï¼ˆ75mmï¼‰ï¼Œæ–°å¢æ”¯ç®¡å‚æ•°ï¼ˆé»˜è®¤2.5å¯¸/63mmï¼‰ -->
            <div class="inp-group">
                <label>ä¸»ç®¡é“é•¿åº¦(ç±³)</label>
                <input type="number" id="mainPipeLength" placeholder="ä¾‹å¦‚ï¼š50" min="0" value="50">
                <span class="clear-btn" onclick="clearInput('mainPipeLength')">Ã—</span>
            </div>
            <div class="inp-group">
                <label>ä¸»ç®¡é“ç›´å¾„ï¼ˆé»˜è®¤3å¯¸ï¼‰</label>
                <select id="mainPipeDiameter">
                    <option value="50">50mmï¼ˆ2å¯¸ï¼‰</option>
                    <option value="63">63mmï¼ˆ2.5å¯¸ï¼‰</option>
                    <option value="75" selected>75mmï¼ˆ3å¯¸ï¼‰</option>
                    <option value="90">90mmï¼ˆ3.5å¯¸ï¼‰</option>
                    <option value="110">110mmï¼ˆ4å¯¸ï¼‰</option>
                </select>
            </div>

            <div class="inp-group">
                <label>æ”¯ç®¡é•¿åº¦(ç±³)</label>
                <input type="number" id="branchPipeLength" placeholder="ä¾‹å¦‚ï¼š100" min="0" value="100">
                <span class="clear-btn" onclick="clearInput('branchPipeLength')">Ã—</span>
            </div>
            <div class="inp-group">
                <label>æ”¯ç®¡ç›´å¾„ï¼ˆé»˜è®¤2.5å¯¸ï¼‰</label>
                <select id="branchPipeDiameter">
                    <option value="50">50mmï¼ˆ2å¯¸ï¼‰</option>
                    <option value="63" selected>63mmï¼ˆ2.5å¯¸ï¼‰</option>
                    <option value="75">75mmï¼ˆ3å¯¸ï¼‰</option>
                </select>
            </div>

            <!-- ä¼˜åŒ–ï¼šä½œç‰©éœ€æ°´é‡ä¸‹æ‹‰é€‰æ‹© -->
            <div class="inp-group">
                <label>ä½œç‰©ç±»å‹åŠéœ€æ°´é‡</label>
                <select id="cropWaterNeed">
                    <option value="30" selected>å°éº¦ï¼ˆ30æ–¹/äº©ï¼‰</option>
                    <option value="40">ç‰ç±³ï¼ˆ40æ–¹/äº©ï¼‰</option>
                    <option value="25">æ°´ç¨»ï¼ˆ25æ–¹/äº©ï¼‰</option>
                    <option value="20">æ£‰èŠ±ï¼ˆ20æ–¹/äº©ï¼‰</option>
                    <option value="custom">è‡ªå®šä¹‰éœ€æ°´é‡</option>
                </select>
            </div>
            <div class="inp-group" id="customCropWaterGroup" style="display:none;">
                <label>è‡ªå®šä¹‰éœ€æ°´é‡(æ–¹/äº©)</label>
                <input type="number" id="customCropWater" placeholder="ä¾‹å¦‚ï¼š30" min="5">
                <span class="clear-btn" onclick="clearInput('customCropWater')">Ã—</span>
                <div class="error-text" id="cropWaterNeedError">è¯·è¾“å…¥å¤§äº5çš„æ•°å€¼</div>
            </div>
            
            <div class="inp-group">
                <label>ç”µè´¹å•ä»·(å…ƒ/åº¦)</label>
                <input type="number" id="electricityPrice" placeholder="ä¾‹å¦‚ï¼š0.56" min="0.01" step="0.01" value="0.56">
                <span class="clear-btn" onclick="clearInput('electricityPrice')">Ã—</span>
                <div class="error-text" id="electricityPriceError">è¯·è¾“å…¥å¤§äº0.01çš„æ•°å€¼</div>
            </div>
        </div>
        
        <button class="calc-btn" id="calcBtn">ğŸšœ è®¡ç®—çŒæº‰æ–¹æ¡ˆ</button>
        
        <div class="result-card" id="resultCard" style="display:none;">
            <div style="margin-bottom:12px;">
                <p>ğŸ“ åœ°å—ä¿¡æ¯ï¼š<span id="plotSize">0Ã—0</span> å¹³æ–¹ç±³ï¼ˆçº¦<span id="plotAcre">0</span>äº©ï¼‰</p>
                <p>ğŸ”« å–·å¤´ç±»å‹ï¼š<span id="gunType">å››å˜´å–·å¤´</span> | æ ‡å‡†è¦†ç›–ç›´å¾„ï¼š<span id="standardDiameter">16</span> ç±³</p>
                <p>âš™ï¸ æ°´æ³µå‚æ•°ï¼š<span id="selectedPump">7.5kWã€63mÂ³/h</span> | æ ‡å‡†å‹åŠ›åŒºé—´ï¼š0.12~0.18MPa</p>
                <p>ğŸ’§ ä½œç‰©éœ€æ°´ï¼š<span id="showCropWater">30</span>æ–¹/äº© | å®é™…çŒæº‰æ—¶é•¿ï¼š<span id="showIrrigateHour">8</span>å°æ—¶/æ‰¹</p>
                <p>ğŸ“¦ ç®¡é“å‚æ•°ï¼šä¸»ç®¡é“<span id="showMainPipe">75mmï¼ˆ3å¯¸ï¼‰Ã—50ç±³</span> | æ”¯ç®¡<span id="showBranchPipe">63mmï¼ˆ2.5å¯¸ï¼‰Ã—100ç±³</span></p>
            </div>

            <div id="pressureAlertWrapper" style="margin-bottom:12px;">
                <div class="optimal-alert" id="optimalAlert">
                    <strong>âœ… æ ‡å‡†å·¥ä½œçŠ¶æ€ï¼š</strong>æ¯æ‰¹æ¬¡å¼€å¯<span id="standardGunsPerBatch">25</span>æ”¯å–·æªï¼Œå‹åŠ›<span id="actualPressure">0.15</span>MPaï¼ˆæ ‡å‡†åŒºé—´å†…ï¼‰ï¼Œå–·å¤´è¦†ç›–ç›´å¾„<span id="showStandardDiameter">16</span>ç±³ï¼
                </div>
                <div class="danger-alert" id="pressureOverAlert" style="display:none;">
                    <strong>âš ï¸ å‹åŠ›è¶…æ ‡è­¦å‘Šï¼š</strong>å½“å‰å¼€å¯å–·æªæ•°è¿‡å°‘ï¼Œå®é™…å‹åŠ›<span id="overPressure">0.22</span>MPaï¼0.18MPaï¼Œå»ºè®®å¢åŠ æ¯æ‰¹æ¬¡å–·æªæ•°æˆ–æ›´æ¢æ›´å°æµé‡æ°´æ³µï¼
                </div>
            </div>

            <p class="highlight">ğŸ¯ æ ¸å¿ƒçŒæº‰æ–¹æ¡ˆ</p>
            <table class="result-table">
                <tr>
                    <td>ç”°é—´æ€»éœ€å–·æªæ•°ï¼ˆéœ€é‡‡è´­ï¼‰</td>
                    <td><span id="totalRequiredGuns">0</span> æ”¯</td>
                </tr>
                <tr>
                    <td>æ¯æ‰¹æ¬¡æ ‡å‡†å¼€å¯å–·æªæ•°</td>
                    <td><span id="showStandardGuns">25</span> æ”¯</td>
                </tr>
                <tr>
                    <td>æ€»çŒæº‰æ‰¹æ¬¡</td>
                    <td><span id="totalBatches">1</span> æ‰¹</td>
                </tr>
                <tr>
                    <td>çŒæº‰æ€»è€—æ—¶</td>
                    <td><span id="totalIrrigateTime">0</span> å°æ—¶</td>
                </tr>
            </table>

            <p class="highlight">ğŸ’° è´¹ç”¨ä¼°ç®—</p>
            <table class="result-table">
                <tr>
                    <td>æ€»è€—ç”µé‡</td>
                    <td><span id="totalElectricity">0</span> åº¦</td>
                </tr>
                <tr>
                    <td>æ€»ç”µè´¹</td>
                    <td><span id="totalElectricityCost">0</span> å…ƒ</td>
                </tr>
            </table>

            <div class="material-title">ğŸ”§ é˜€é—¨ç‰©æ–™æ¸…å•</div>
            <table class="result-table">
                <tr>
                    <td>å•æªæ§åˆ¶é˜€é—¨ï¼ˆä¸ªï¼‰</td>
                    <td><span id="valveSingleGun">0</span> ä¸ª</td>
                </tr>
                <tr>
                    <td>ä¸»ç®¡é“æ€»é˜€é—¨ï¼ˆä¸ªï¼‰</td>
                    <td><span id="valveMain">1</span> ä¸ª</td>
                </tr>
                <tr>
                    <td>é˜€é—¨æ€»è®¡ï¼ˆä¸ªï¼‰</td>
                    <td><span id="valveTotal">0</span> ä¸ª</td>
                </tr>
            </table>

            <div class="batch-tips">
                <strong>ğŸ’¡ æ“ä½œæŒ‡å¼•ï¼š</strong><br>
                1. ç”°é—´æŒ‰<span id="tipDiameter">16</span>ç±³é—´è·é“ºè®¾<span id="tipTotalGuns">0</span>æ”¯å–·æªï¼Œæ¯æ”¯æªé…1ä¸ªç‹¬ç«‹æ§åˆ¶é˜€é—¨ï¼›<br>
                2. æ¯æ‰¹æ¬¡å¼€å¯<span id="tipBatchGuns">25</span>æ”¯å–·æªï¼Œå…³é—­å…¶ä½™å–·æªï¼Œç¡®ä¿å‹åŠ›ç¨³å®šåœ¨æ ‡å‡†åŒºé—´ï¼›<br>
                3. æ¯æ‰¹æ¬¡çŒæº‰<span id="tipHour">8</span>å°æ—¶ï¼Œå®Œæˆåç›´æ¥åˆ‡æ¢å¼€å¯ä¸‹ä¸€æ‰¹æ¬¡å–·æªï¼›<br>
                4. ä¸»ç®¡é“é»˜è®¤3å¯¸ï¼ˆ75mmï¼‰ï¼Œæ”¯ç®¡é»˜è®¤2.5å¯¸ï¼ˆ63mmï¼‰ï¼Œç®¡é“æŸè€—å·²è‡ªåŠ¨ä¿®æ­£ã€‚
            </div>
        </div>
        
        <p class="tips">å•æªç‹¬ç«‹æ§åˆ¶ | åˆ†æ‰¹æ¬¡çŒæº‰ | ä¸»æ”¯ç®¡é“æŸè€—ä¿®æ­£ | é˜€é—¨ç‰©æ–™è®¡ç®— | ä½œç‰©éœ€æ°´æ—¶é•¿ | é”€å”®ä¸“ç”¨</p>
    </div>

    <script>
        // æ ¸å¿ƒé…ç½®ï¼šå›ºå®šæ ‡å‡†å‚æ•°
        const GUN_CONFIG = {
            four: { 
                type: 'å››å˜´å–·å¤´', 
                standardFlow: 2.5,       // æ ‡å‡†å‹åŠ›ä¸‹çš„å•æªæµé‡
                standardDiameter: 16,    // æ ‡å‡†è¦†ç›–ç›´å¾„
                optimalPressureMin: 0.12,
                optimalPressureMax: 0.18,
                gap: 16                  // å–·æªé“ºè®¾é—´è·
            },
            sand: { 
                type: 'é˜²æ²™å–·å¤´', 
                standardFlow: 1.3,       // æ ‡å‡†å‹åŠ›ä¸‹çš„å•æªæµé‡
                standardDiameter: 10,    // æ ‡å‡†è¦†ç›–ç›´å¾„
                optimalPressureMin: 0.12,
                optimalPressureMax: 0.18,
                gap: 10                  // å–·æªé“ºè®¾é—´è·
            }
        };

        const PIPE_CONFIG = {
            mainPipe: { maxPressure: 0.6 },
            branchPipe: { maxPressure: 0.2, maxGuns: 50 },
            // ä¸»ç®¡é“+æ”¯ç®¡æŸè€—ç³»æ•°ï¼ˆç»éªŒå€¼ï¼‰
            lossCoefficient: {
                main: { "50":0.15, "63":0.10, "75":0.08, "90":0.05, "110":0.03 },
                branch: { "50":0.20, "63":0.15, "75":0.10 }
            }
        };
        const PUMP_EFFICIENCY = 0.7;
        const POWER_FLOW_MAP = {
            "3": "25", "4": "38", "5.5": "50", "7.5": "63", 
            "11": "88", "15": "113", "18.5": "138", "22": "163", "30": "200"
        };

        // DOMå…ƒç´ 
        const plotMu = document.getElementById('plotMu');
        const plotLength = document.getElementById('plotLength');
        const plotWidth = document.getElementById('plotWidth');
        const muCalcBtn = document.getElementById('muCalcBtn');
        const muError = document.getElementById('muError');
        const lengthError = document.getElementById('lengthError');
        const widthError = document.getElementById('widthError');
        const gunToggle = document.getElementById('gunToggle');
        const showAdvBtn = document.getElementById('showAdvBtn');
        const advancedParams = document.getElementById('advancedParams');
        const pumpPowerSelect = document.getElementById('pumpPowerSelect');
        const customPowerGroup = document.getElementById('customPowerGroup');
        const customPower = document.getElementById('customPower');
        const customPowerError = document.getElementById('customPowerError');
        const pumpFlowSelect = document.getElementById('pumpFlowSelect');
        const customFlowGroup = document.getElementById('customFlowGroup');
        const customFlow = document.getElementById('customFlow');
        const customFlowError = document.getElementById('customFlowError');
        const mainPipeLength = document.getElementById('mainPipeLength');
        const mainPipeDiameter = document.getElementById('mainPipeDiameter');
        const branchPipeLength = document.getElementById('branchPipeLength');
        const branchPipeDiameter = document.getElementById('branchPipeDiameter');
        const cropWaterNeed = document.getElementById('cropWaterNeed');
        const customCropWaterGroup = document.getElementById('customCropWaterGroup');
        const customCropWater = document.getElementById('customCropWater');
        const cropWaterNeedError = document.getElementById('cropWaterNeedError');
        const electricityPrice = document.getElementById('electricityPrice');
        const electricityPriceError = document.getElementById('electricityPriceError');
        const calcBtn = document.getElementById('calcBtn');
        const resultCard = document.getElementById('resultCard');
        const plotSize = document.getElementById('plotSize');
        const plotAcre = document.getElementById('plotAcre');
        const gunType = document.getElementById('gunType');
        const standardDiameter = document.getElementById('standardDiameter');
        const selectedPump = document.getElementById('selectedPump');
        const showCropWater = document.getElementById('showCropWater');
        const showIrrigateHour = document.getElementById('showIrrigateHour');
        const showMainPipe = document.getElementById('showMainPipe');
        const showBranchPipe = document.getElementById('showBranchPipe');
        const pressureAlertWrapper = document.getElementById('pressureAlertWrapper');
        const optimalAlert = document.getElementById('optimalAlert');
        const pressureOverAlert = document.getElementById('pressureOverAlert');
        const standardGunsPerBatch = document.getElementById('standardGunsPerBatch');
        const showStandardDiameter = document.getElementById('showStandardDiameter');
        const actualPressure = document.getElementById('actualPressure');
        const overPressure = document.getElementById('overPressure');
        const totalRequiredGuns = document.getElementById('totalRequiredGuns');
        const showStandardGuns = document.getElementById('showStandardGuns');
        const totalBatches = document.getElementById('totalBatches');
        const totalIrrigateTime = document.getElementById('totalIrrigateTime');
        const totalElectricity = document.getElementById('totalElectricity');
        const totalElectricityCost = document.getElementById('totalElectricityCost');
        const valveSingleGun = document.getElementById('valveSingleGun');
        const valveMain = document.getElementById('valveMain');
        const valveTotal = document.getElementById('valveTotal');
        const tipDiameter = document.getElementById('tipDiameter');
        const tipTotalGuns = document.getElementById('tipTotalGuns');
        const tipBatchGuns = document.getElementById('tipBatchGuns');
        const tipHour = document.getElementById('tipHour');

        let currentGunType = 'four';
        let showAdvanced = false;

        // æ¸…é™¤è¾“å…¥æ¡†
        function clearInput(inputId) {
            const inputEl = document.getElementById(inputId);
            inputEl.value = '';
            inputEl.classList.remove('invalid');
            const errorEl = document.getElementById(`${inputId}Error`);
            if (errorEl) errorEl.style.display = 'none';
            const clearBtn = inputEl.nextElementSibling;
            if (clearBtn && clearBtn.classList.contains('clear-btn')) {
                clearBtn.style.display = 'none';
            }
        }

        // è¾“å…¥æ¡†å®æ—¶æ˜¾ç¤ºæ¸…é™¤æŒ‰é’®
        document.querySelectorAll('.inp-group input').forEach(input => {
            input.addEventListener('input', () => {
                const clearBtn = input.nextElementSibling;
                if (clearBtn && clearBtn.classList.contains('clear-btn')) {
                    clearBtn.style.display = input.value.trim() ? 'block' : 'none';
                }
            });
        });

        // éªŒè¯è¾“å…¥
        function validateInput(inputEl, errorEl, minVal) {
            const value = Number(inputEl.value) || 0;
            if (value < minVal) {
                inputEl.classList.add('invalid');
                errorEl.style.display = 'block';
                return false;
            } else {
                inputEl.classList.remove('invalid');
                errorEl.style.display = 'none';
                return true;
            }
        }

        // æ°´æ³µåŠŸç‡-æµé‡è”åŠ¨
        pumpPowerSelect.addEventListener('change', () => {
            customPowerGroup.style.display = pumpPowerSelect.value === 'custom' ? 'block' : 'none';
            if (pumpPowerSelect.value !== 'custom' && POWER_FLOW_MAP[pumpPowerSelect.value]) {
                pumpFlowSelect.value = POWER_FLOW_MAP[pumpPowerSelect.value];
                customFlowGroup.style.display = 'none';
            }
        });

        pumpFlowSelect.addEventListener('change', () => {
            customFlowGroup.style.display = pumpFlowSelect.value === 'custom' ? 'block' : 'none';
        });

        // ä½œç‰©éœ€æ°´é‡ä¸‹æ‹‰è”åŠ¨
        cropWaterNeed.addEventListener('change', () => {
            customCropWaterGroup.style.display = cropWaterNeed.value === 'custom' ? 'block' : 'none';
        });

        // åˆ‡æ¢å–·å¤´ç±»å‹
        gunToggle.addEventListener('click', () => {
            gunToggle.classList.toggle('active');
            currentGunType = gunToggle.classList.contains('active') ? 'sand' : 'four';
            const config = GUN_CONFIG[currentGunType];
            gunType.textContent = config.type;
            standardDiameter.textContent = config.standardDiameter;
        });

        // å±•å¼€/æ”¶èµ·é«˜çº§å‚æ•°
        showAdvBtn.addEventListener('click', () => {
            showAdvanced = !showAdvanced;
            advancedParams.classList.toggle('advanced-hidden', !showAdvanced);
            showAdvBtn.textContent = showAdvanced ? 'âš™ï¸ æ”¶èµ·ä¸“ä¸šå‚æ•°' : 'âš™ï¸ å±•å¼€ä¸“ä¸šå‚æ•°';
        });

        // äº©æ•°-é•¿å®½äº’ç®—
        function autoCalcMu() {
            const len = Number(plotLength.value) || 0;
            const wid = Number(plotWidth.value) || 0;
            if (len >= 1 && wid >= 1) {
                plotMu.value = (len * wid / 666.67).toFixed(1);
                validateInput(plotMu, muError, 0.1);
            }
        }
        plotLength.addEventListener('input', autoCalcMu);
        plotWidth.addEventListener('input', autoCalcMu);

        muCalcBtn.addEventListener('click', () => {
            const mu = Number(plotMu.value) || 0;
            const len = Number(plotLength.value) || 0;
            const wid = Number(plotWidth.value) || 0;

            if (mu < 0.1) {
                alert('è¯·å…ˆè¾“å…¥æœ‰æ•ˆçš„äº©æ•°ï¼ˆâ‰¥0.1ï¼‰');
                return;
            }

            if (len >= 1 && wid === 0) {
                plotWidth.value = (mu * 666.67 / len).toFixed(1);
                validateInput(plotWidth, widthError, 1);
            } else if (wid >= 1 && len === 0) {
                plotLength.value = (mu * 666.67 / wid).toFixed(1);
                validateInput(plotLength, lengthError, 1);
            } else {
                alert('è¯·ç¡®ä¿åªå¡«å†™äº©æ•°+é•¿åº¦ æˆ– äº©æ•°+å®½åº¦');
            }
        });

        // è®¡ç®—æ€»éœ€å–·æªæ•°
        function getTotalRequiredGuns(len, wid, gap) {
            if (len <= 0 || wid <= 0) return 0;
            const rowCount = Math.ceil(len / gap);
            const colCount = Math.ceil(wid / gap);
            return rowCount * colCount;
        }

        // ä¼˜åŒ–ï¼šè®¡ç®—ä¸»ç®¡é“+æ”¯ç®¡æ€»æŸè€—åçš„å®é™…æµé‡
        function calcActualFlow(ratedFlow, mainPipeDia, mainPipeLen, branchPipeDia, branchPipeLen) {
            // ä¸»ç®¡é“æŸè€—
            const mainLossCoeff = PIPE_CONFIG.lossCoefficient.main[mainPipeDia] || 0.08;
            const mainLengthCoeff = Math.ceil(mainPipeLen / 100);
            const mainLoss = mainLossCoeff * mainLengthCoeff;

            // æ”¯ç®¡æŸè€—
            const branchLossCoeff = PIPE_CONFIG.lossCoefficient.branch[branchPipeDia] || 0.15;
            const branchLengthCoeff = Math.ceil(branchPipeLen / 100);
            const branchLoss = branchLossCoeff * branchLengthCoeff;

            // æ€»æŸè€— = ä¸»ç®¡é“æŸè€— + æ”¯ç®¡æŸè€—ï¼ˆä¸è¶…è¿‡50%ï¼‰
            const totalLoss = Math.min(mainLoss + branchLoss, 0.5);
            const actualFlow = ratedFlow * (1 - totalLoss);
            return Math.max(actualFlow, ratedFlow * 0.5);
        }

        // è®¡ç®—ä½œç‰©éœ€æ°´å¯¹åº”çš„çŒæº‰æ—¶é•¿
        function calcIrrigateHour(cropWaterPerMu, mu, batchGuns, singleGunFlow) {
            const singleGunArea = (Math.PI * Math.pow(GUN_CONFIG[currentGunType].standardDiameter / 2, 2)) / 666.67;
            const batchArea = batchGuns * singleGunArea;
            const batchWaterNeed = batchArea * cropWaterPerMu;
            const batchWaterOut = batchGuns * singleGunFlow;
            if (batchWaterOut <= 0) return 8;
            const hour = batchWaterNeed / batchWaterOut;
            return Math.max(1, Math.min(24, hour));
        }

        // è®¡ç®—å®é™…å·¥ä½œå‹åŠ›
        function calcActualPressure(pumpPower, actualFlow) {
            const pressure = (pumpPower * 0.1) / actualFlow * 10;
            return pressure.toFixed(2);
        }

        // è®¡ç®—æ¯æ‰¹æ¬¡æ ‡å‡†å–·æªæ•°
        function calcStandardGunsPerBatch(actualFlow, singleStandardFlow) {
            let standardGuns = Math.floor(actualFlow / singleStandardFlow);
            standardGuns = Math.min(standardGuns, PIPE_CONFIG.branchPipe.maxGuns);
            return Math.max(standardGuns, 1);
        }

        // ä¸»è®¡ç®—é€»è¾‘
        calcBtn.addEventListener('click', () => {
            // åŸºç¡€å‚æ•°éªŒè¯
            const muVal = Number(plotMu.value) || 0;
            const lenVal = Number(plotLength.value) || 0;
            const widVal = Number(plotWidth.value) || 0;
            const validParamCount = [muVal >= 0.1, lenVal >= 1, widVal >= 1].filter(Boolean).length;

            if (validParamCount < 2) {
                alert('è¯·è‡³å°‘å¡«å†™2ä¸ªæœ‰æ•ˆçš„åœ°å—å‚æ•°ï¼ˆäº©æ•°â‰¥0.1/é•¿åº¦â‰¥1/å®½åº¦â‰¥1ï¼‰');
                resultCard.style.display = 'none';
                return;
            }

            let muValid = true, lenValid = true, widValid = true;
            if (plotMu.value) muValid = validateInput(plotMu, muError, 0.1);
            if (plotLength.value) lenValid = validateInput(plotLength, lengthError, 1);
            if (plotWidth.value) widValid = validateInput(plotWidth, widthError, 1);
            if (!muValid || !lenValid || !widValid) {
                resultCard.style.display = 'none';
                return;
            }

            // è®¡ç®—æœ€ç»ˆåœ°å—å‚æ•°
            let finalMu = muVal;
            let finalLen = lenVal;
            let finalWid = widVal;
            if (finalMu >= 0.1 && finalLen >= 1 && finalWid < 1) finalWid = (finalMu * 666.67 / finalLen);
            if (finalMu >= 0.1 && finalWid >= 1 && finalLen < 1) finalLen = (finalMu * 666.67 / finalWid);
            if (finalLen >= 1 && finalWid >= 1 && finalMu < 0.1) finalMu = (finalLen * finalWid / 666.67);

            // é«˜çº§å‚æ•°éªŒè¯
            if (showAdvanced) {
                if (pumpPowerSelect.value === 'custom' && !validateInput(customPower, customPowerError, 1)) {
                    resultCard.style.display = 'none';
                    return;
                }
                if (pumpFlowSelect.value === 'custom' && !validateInput(customFlow, customFlowError, 5)) {
                    resultCard.style.display = 'none';
                    return;
                }
                let cropWaterValid = true;
                if (cropWaterNeed.value === 'custom') {
                    cropWaterValid = validateInput(customCropWater, cropWaterNeedError, 5);
                }
                if (!cropWaterValid || !validateInput(electricityPrice, electricityPriceError, 0.01)) {
                    resultCard.style.display = 'none';
                    return;
                }
            }

            // è·å–åŸºç¡€é…ç½®
            const gunConfig = GUN_CONFIG[currentGunType];
            const selectedPower = showAdvanced 
                ? (pumpPowerSelect.value === 'custom' ? Number(customPower.value) : Number(pumpPowerSelect.value))
                : 7.5;
            const ratedFlow = showAdvanced
                ? (pumpFlowSelect.value === 'custom' ? Number(customFlow.value) : Number(pumpFlowSelect.value))
                : 63;
            const mainPipeDia = showAdvanced ? mainPipeDiameter.value : "75";
            const mainPipeLen = showAdvanced ? Number(mainPipeLength.value) || 50 : 50;
            const branchPipeDia = showAdvanced ? branchPipeDiameter.value : "63";
            const branchPipeLen = showAdvanced ? Number(branchPipeLength.value) || 100 : 100;
            let cropWater = 30;
            if (showAdvanced) {
                cropWater = cropWaterNeed.value === 'custom' ? Number(customCropWater.value) || 30 : Number(cropWaterNeed.value);
            }
            const elecPrice = showAdvanced ? Number(electricityPrice.value) || 0.56 : 0.56;

            // æ ¸å¿ƒè®¡ç®—
            const actualFlow = calcActualFlow(ratedFlow, mainPipeDia, mainPipeLen, branchPipeDia, branchPipeLen);
            const standardGuns = calcStandardGunsPerBatch(actualFlow, gunConfig.standardFlow);
            const totalGuns = getTotalRequiredGuns(finalLen, finalWid, gunConfig.gap);
            const totalBatch = Math.ceil(totalGuns / standardGuns);
            const irrigateHour = calcIrrigateHour(cropWater, finalMu, standardGuns, gunConfig.standardFlow);
            const totalTime = totalBatch * irrigateHour;
            const pressure = calcActualPressure(selectedPower, actualFlow);
            const isPressureOver = Number(pressure) > gunConfig.optimalPressureMax;
            const singleGunValve = totalGuns;
            const mainValve = 1;
            const totalValve = singleGunValve + mainValve;
            const totalElec = (selectedPower * totalTime).toFixed(2);
            const totalCost = (totalElec * elecPrice).toFixed(2);

            // æ›´æ–°é¡µé¢æ˜¾ç¤º
            plotSize.textContent = `${finalLen.toFixed(1)}Ã—${finalWid.toFixed(1)}`;
            plotAcre.textContent = finalMu.toFixed(1);
            gunType.textContent = gunConfig.type;
            standardDiameter.textContent = gunConfig.standardDiameter;
            selectedPump.textContent = `${selectedPower}kWã€${ratedFlow}mÂ³/hï¼ˆå®é™…æµé‡ï¼š${actualFlow.toFixed(1)}mÂ³/hï¼‰`;
            showCropWater.textContent = cropWater;
            showIrrigateHour.textContent = irrigateHour.toFixed(1);
            showMainPipe.textContent = `${mainPipeDia}mmï¼ˆ${mainPipeDiameter.options[mainPipeDiameter.selectedIndex].text.split('ï¼ˆ')[1].split('ï¼‰')[0]}ï¼‰Ã—${mainPipeLen}ç±³`;
            showBranchPipe.textContent = `${branchPipeDia}mmï¼ˆ${branchPipeDiameter.options[branchPipeDiameter.selectedIndex].text.split('ï¼ˆ')[1].split('ï¼‰')[0]}ï¼‰Ã—${branchPipeLen}ç±³`;

            // å‹åŠ›çŠ¶æ€æ˜¾ç¤º
            optimalAlert.style.display = isPressureOver ? 'none' : 'block';
            pressureOverAlert.style.display = isPressureOver ? 'block' : 'none';
            actualPressure.textContent = pressure;
            overPressure.textContent = pressure;
            standardGunsPerBatch.textContent = standardGuns;
            showStandardDiameter.textContent = gunConfig.standardDiameter;

            totalRequiredGuns.textContent = totalGuns;
            showStandardGuns.textContent = standardGuns;
            totalBatches.textContent = totalBatch;
            totalIrrigateTime.textContent = totalTime.toFixed(1);

            totalElectricity.textContent = totalElec;
            totalElectricityCost.textContent = totalCost;

            // é˜€é—¨ç‰©æ–™æ˜¾ç¤º
            valveSingleGun.textContent = singleGunValve;
            valveMain.textContent = mainValve;
            valveTotal.textContent = totalValve;

            // æ“ä½œæŒ‡å¼•
            tipDiameter.textContent = gunConfig.standardDiameter;
            tipTotalGuns.textContent = totalGuns;
            tipBatchGuns.textContent = standardGuns;
            tipHour.textContent = irrigateHour.toFixed(1);

            // æ˜¾ç¤ºç»“æœ
            resultCard.style.display = 'block';
        });

        // é¡µé¢åˆå§‹åŒ–
        window.onload = function() {
            const config = GUN_CONFIG[currentGunType];
            gunType.textContent = config.type;
            standardDiameter.textContent = config.standardDiameter;
            resultCard.style.display = 'none';
        };
    </script>
</body>
</html>
