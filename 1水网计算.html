<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
    <title>å–·å¤´è®¡ç®—å™¨</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{padding:15px;font-family:Arial;font-size:14px;background:#f5f5f5;}
        .box{max-width:600px;margin:0 auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 0 12px rgba(0,0,0,0.15);position:relative;}
        h1{text-align:center;color:#2c3e50;font-size:18px;margin-bottom:25px;font-weight:bold;}
        .inp-group{margin-bottom:18px;}
        .inp-group label{display:block;margin-bottom:6px;color:#34495e;font-weight:500;}
        .inp-group input{width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:15px;outline:none;}
        .inp-group select{width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:15px;outline:none;background:#fff;}
        .inp-group input:focus{border-color:#3498db;}
        .btn{width:100%;padding:13px;background:#27ae60;color:#fff;border:none;border-radius:6px;font-size:16px;font-weight:bold;cursor:pointer;margin:10px 0 25px;}
        .btn:active{background:#219a52;}
        .result{display:none;}
        .title{font-size:16px;color:#2c3e50;font-weight:bold;margin:18px 0 12px;padding-bottom:6px;border-bottom:2px solid #ecf0f1;}
        .param p{line-height:2.2;color:#34495e;margin:6px 0;}
        table{width:100%;border-collapse:collapse;margin:10px 0;}
        th,td{border:1px solid #ddd;padding:8px;text-align:center;}
        th{background:#ecf0f1;color:#2c3e50;font-weight:bold;}
        .total{background:#f8f9fa;font-weight:bold;color:#e74c3c;}
        .discount-row{background:#fdf2f8;color:#9f7aea;font-weight:bold;}
        .final-total{background:#e8f5e9;color:#27ae60;font-weight:bold;font-size:15px;}
        .tips{font-size:12px;color:#7f8c8d;margin-top:10px;text-align:center;}
        .qty-input{width:60px;padding:4px;text-align:center;border:1px solid #ddd;border-radius:4px;}
        .qty-input:disabled{background:#f5f5f5;cursor:not-allowed;}
        .custom-item{display:none;} /* éšè—ä»¶é»˜è®¤éšè— */
        .show-custom .custom-item{display:table-row;}
        /* æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶æ˜¾ç¤ºæœ‰æ•°é‡çš„éšè—é…ä»¶ï¼Œä¼˜å…ˆçº§æœ€é«˜ */
        .custom-item.show-custom-item{display:table-row !important;}
        /* æ–°å¢ï¼šå¼ºåˆ¶æ˜¾ç¤ºæœ‰æ•°é‡çš„hide-itemé…ä»¶ï¼Œä¼˜å…ˆçº§æœ€é«˜ */
.hide-item.show-hide-item{display:table-row !important;}
        .hide-item{display:none;} /* å®Œå…¨éšè—çš„è¡Œï¼ˆä»…ç”¨äºåˆå§‹åŒºåˆ†ï¼Œæ˜¾ç¤ºæŒ‰é’®è§¦å‘åå…¨éƒ¨æ˜¾ç¤ºï¼‰ */
        .hidden-visually{visibility:hidden;} /* è§†è§‰éšè—ä½†ä¿ç•™ä½ç½® */
        /* æ­£å¸¸ä»¶åº•è‰² */
        .dili{background-color: #e8f5e9;} /* åœ°é‡Œå¿…å¤‡-æµ…ç»¿ */
        .ditou{background-color: #e3f2fd;} /* åœ°å¤´å¿…å¤‡-æµ…è“ */
        .beiyong{background-color: #fff3e0;} /* å¤‡ç”¨ä»¶-æµ…é»„ */
        /* éšè—ä»¶åº•è‰²ï¼ˆå¯¹åº”åˆ†ç±»æµ…ç°è°ƒï¼Œä¿ç•™è¾¨è¯†åº¦ï¼‰ */
        .custom-item.dili{background-color: #f2f9f2;} /* åœ°é‡Œéšè—ä»¶-æµ…ç»¿ç° */
        .custom-item.ditou{background-color: #f2f7fd;} /* åœ°å¤´éšè—ä»¶-æµ…è“ç° */
        .custom-item.beiyong{background-color: #fef9f2;} /* å¤‡ç”¨ä»¶-æµ…é»„ç° */
        .switch-container{display:flex;justify-content:space-between;align-items:center;margin:15px 0;padding:0 10px;flex-wrap:wrap;gap:10px;}
        .switch-wrap{display:flex;align-items:center;gap:8px;cursor:pointer;}
        .switch{position:relative;width:50px;height:26px;border-radius:13px;background:#ddd;cursor:pointer;transition:background 0.3s;}
        .switch::after{content:'';position:absolute;width:22px;height:22px;border-radius:50%;background:#fff;top:2px;left:2px;transition:left 0.3s;}
        .switch.active{background:#3498db;}
        .switch.active::after{left:26px;}
        .switch-text{font-size:13px;color:#34495e;font-weight:500;white-space:nowrap;}
        .gun-switch-wrap{display:flex;justify-content:center;align-items:center;gap:10px;margin-bottom:20px;padding:10px;background:#f8f9fa;border-radius:8px;flex-wrap:wrap;}
        .history-btn-group{position:absolute;top:20px;right:20px;display:flex;gap:8px;}
        .history-small-btn{width:40px;height:40px;border-radius:50%;border:none;background:#f1f5f9;color:#2c3e50;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;}
        .history-small-btn:hover{background:#e1eaf1;}
        .history-small-btn.clear-btn{background:#fef2f2;color:#dc2626;}
        .history-panel{margin:15px 0;padding:10px;background:#f8fafc;border-radius:6px;max-height:150px;overflow-y:auto;display:none;}
        .history-panel.show{display:block;}
        .history-item{padding:8px;border-bottom:1px solid #e2e8f0;cursor:pointer;transition:background 0.2s;}
        .history-item:last-child{border-bottom:none;}
        .history-item:hover{background:#e6f7ff;}
        .history-item span{display:inline-block;margin:0 4px;color:#34495e;font-size:13px;}
        .history-time{color:#7f8c8d;font-size:12px;}
        .modal-mask{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:999;display:none;}
        .modal-box{background:#fff;padding:25px;border-radius:10px;width:80%;max-width:300px;text-align:center;}
        .modal-title{font-size:16px;color:#2c3e50;font-weight:bold;margin-bottom:20px;}
        .modal-btn-group{display:flex;gap:10px;}
        .modal-btn{flex:1;padding:10px;border:none;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;}
        .modal-confirm{background:#dc2626;color:#fff;}
        .modal-cancel{background:#f1f5f9;color:#2c3e50;}
        /* ä¼˜æƒ å‡å…åŒºåŸŸæ ·å¼ */
        .discount-container{margin:15px 0;padding:15px;background:#faf0f5;border-radius:8px;}
        .discount-title{font-size:15px;color:#2c3e50;font-weight:bold;margin-bottom:10px;}
        .discount-input-group{display:flex;gap:10px;margin-bottom:10px;}
        .discount-input-group input{flex:1;}
        .discount-btn{width:100%;padding:10px;background:#9f7aea;color:#fff;border:none;border-radius:6px;font-size:14px;font-weight:bold;cursor:pointer;}
        .discount-btn:active{background:#805ad5;}
        /* ç§»åŠ¨ç«¯è¡¨æ ¼é€‚é… */
        @media screen and (max-width: 480px) {
            th,td{padding:4px;font-size:12px;}
            .qty-input{width:40px;padding:2px;}
            .discount-input-group{flex-direction:column;}
        }
    </style>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
    <div class="box">
        <h1>å–·å¤´è®¡ç®—å™¨</h1>
        <div class="history-btn-group">
            <button class="history-small-btn" id="toggleHistoryBtn">ğŸ“œ</button>
            <button class="history-small-btn clear-btn" id="clearHistoryBtn">ğŸ—‘ï¸</button>
        </div>
        
        <!-- å–·å¤´ç±»å‹ä¸‹æ‹‰æ¡† -->
        <div class="inp-group">
            <label>å–·å¤´ç±»å‹</label>
            <select id="nozzleType">
                <option value="four">å››å˜´å–·å¤´</option>
                <option value="sand">é˜²æ²™å–·å¤´</option>
                <option value="custom">è‡ªå®šä¹‰å–·å¤´</option>
            </select>
        </div>
        
        <div class="gun-switch-wrap">
            <div class="switch-wrap" data-size="1.2">
                <span class="switch-text">1.2ç±³å–·å¤´</span>
                <div class="switch active" id="gun12Switch"></div>
            </div>
            <div class="switch-wrap" data-size="1.5">
                <span class="switch-text">1.5ç±³å–·å¤´</span>
                <div class="switch" id="gun15Switch"></div>
            </div>
        </div>
        
        <div class="inp-group">
            <label>åœ°å—é•¿åº¦(ç±³)</label>
            <input type="number" id="plotLength" placeholder="ä¾‹ï¼š200" min="1" value="200">
        </div>
        <div class="inp-group">
            <label>åœ°å—å®½åº¦(ç±³)</label>
            <input type="number" id="plotWidth" placeholder="ä¾‹ï¼š48" min="1" value="48">
        </div>
        <div class="inp-group">
            <label>å–·å¤´é—´è·(ç±³)</label>
            <input type="number" id="nozzleDiameter" placeholder="å››å˜´16/é˜²æ²™10" min="8" value="16">
        </div>
        <div class="inp-group">
            <label>åˆ—é—´è·(ç±³)</label>
            <input type="number" id="colGap" placeholder="å››å˜´16/é˜²æ²™10" min="5" value="16">
        </div>
        
        <div class="history-panel" id="historyPanel"></div>
        <button class="btn" id="calcBtn">è®¡ç®—</button>
        
        <div class="result" id="result">
            <div class="switch-container">
                <div class="switch-wrap" data-action="edit">
                    <span class="switch-text" id="editText">é”å®šæ•°é‡</span>
                    <div class="switch" id="editSwitch"></div>
                </div>
                <div class="switch-wrap" data-action="custom">
                    <span class="switch-text" id="customText">æ˜¾ç¤ºæ‰€æœ‰é…ä»¶</span>
                    <div class="switch" id="customSwitch"></div>
                </div>
            </div>
            
            <!-- æ–°å¢ï¼šä¼˜æƒ å‡å…åŒºåŸŸ -->
            <div class="discount-container">
                <div class="discount-title">ğŸ’° ä¼˜æƒ å‡å…</div>
                <div class="discount-input-group">
                    <input type="number" id="discountAmount" placeholder="è¾“å…¥å‡å…é‡‘é¢ï¼ˆå…ƒï¼‰" min="0" step="0.1" value="0">
                </div>
                <button class="discount-btn" id="applyDiscountBtn">åº”ç”¨å‡å…</button>
            </div>
            
            <div class="title">ä¸€ã€æ ¸å¿ƒå‚æ•°</div>
            <div class="param" id="param"></div>
            <div class="title">äºŒã€ç‰©æ–™æ¸…å•</div>
            <table id="materialTable">
    <tr>
    <th>åˆ†ç±»</th>
    <th>é…ä»¶åç§°</th>
    <th>è§„æ ¼</th>
    <th>å•ä»·(å…ƒ)</th>
    <th>æ•°é‡</th>
    <th>åˆè®¡(å…ƒ)</th>
</tr>
    <!-- åœ°é‡Œå¿…å¤‡ - å–·å¤´ -->
    <tr class="dili" id="nozzleTr">
        <td>åœ°é‡Œå¿…å¤‡</td>
        <td id="nozzleName">1.2ç±³å››å˜´å–·å¤´æ•´å¥—</td>
        <td>å¥—</td>
        <td id="nozzlePrice">20</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q1" min="0" value="0" disabled></td>
        <td id="s1">0.0</td>
    </tr>
    <!-- å››å˜´ä¸“å±æ”¯ç®¡ -->
    <tr class="dili hide-item" id="pipe8mTr">
        <td>åœ°é‡Œå¿…å¤‡</td>
        <td>2.5å¯¸æ”¯ç®¡æ•´å¥—(8ç±³)</td>
        <td>ç›˜</td>
        <td>26</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q2" min="0" value="0" disabled></td>
        <td id="s2">0.0</td>
    </tr>
    <tr class="dili hide-item" id="pipe16mTr">
        <td>åœ°é‡Œå¿…å¤‡</td>
        <td>2.5å¯¸æ”¯ç®¡æ•´å¥—(16ç±³)</td>
        <td>ç›˜</td>
        <td>39</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q3" min="0" value="0" disabled></td>
        <td id="s3">0.0</td>
    </tr>
    <!-- é˜²æ²™ä¸“å±æ”¯ç®¡ -->
    <tr class="dili hide-item" id="pipe5mTr">
        <td>åœ°é‡Œå¿…å¤‡</td>
        <td>2.5å¯¸æ”¯ç®¡æ•´å¥—(5ç±³)</td>
        <td>ç›˜</td>
        <td>14</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q_s5" min="0" value="0" disabled></td>
        <td id="s_s5">0.0</td>
    </tr>
    <tr class="dili hide-item" id="pipe10mTr">
        <td>åœ°é‡Œå¿…å¤‡</td>
        <td>2.5å¯¸æ”¯ç®¡æ•´å¥—(10ç±³)</td>
        <td>ç›˜</td>
        <td>27</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q_s10" min="0" value="0" disabled></td>
        <td id="s_s10">0.0</td>
    </tr>
    <!-- é€šç”¨åœ°é‡Œç‰©æ–™ -->
    <tr class="dili" id="rawTapeTr">
        <td>åœ°é‡Œå¿…å¤‡</td>
        <td>ç”Ÿæ–™å¸¦</td>
        <td>å·</td>
        <td>0.8</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q4" min="0" value="0" disabled></td>
        <td id="s4">0.0</td>
    </tr>
    <tr class="dili" id="rubberPlugTr">
        <td>åœ°é‡Œå¿…å¤‡</td>
        <td>2.5å¯¸å µå¤´(èƒ¶)</td>
        <td>ä¸ª</td>
        <td>1.5</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q5" min="0" value="0" disabled></td>
        <td id="s5">0.0</td>
    </tr>
    <!-- åœ°å¤´å¿…å¤‡ - ä¸»ç®¡ -->
    <tr class="ditou hide-item" id="main16mTr">
        <td>åœ°å¤´å¿…å¤‡</td>
        <td>3å¯¸16ç±³ä¸»ç®¡å¥—è£…</td>
        <td>ç›˜</td>
        <td>62</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q8" min="0" value="0" disabled></td>
        <td id="s8">0.0</td>
    </tr>
    <tr class="ditou hide-item" id="main10mTr">
        <td>åœ°å¤´å¿…å¤‡</td>
        <td>3å¯¸ä¸»ç®¡10ç±³</td>
        <td>ç›˜</td>
        <td>43</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q_s3" min="0" value="0" disabled></td>
        <td id="s_s3">0.0</td>
    </tr>
    <!-- é€šç”¨åœ°å¤´ç‰©æ–™ -->
    <tr class="ditou hide-item" id="threeWayTr">
        <td>åœ°å¤´å¿…å¤‡</td>
        <td>3å¯¸è½¬2.5å¯¸ä¸‰é€š1é˜€æ•´å¥—</td>
        <td>å¥—</td>
        <td>39</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q6" min="0" value="0" disabled></td>
        <td id="s6">0.0</td>
    </tr>
    <tr class="ditou hide-item" id="fourWayTr">
        <td>åœ°å¤´å¿…å¤‡</td>
        <td>3å¯¸è½¬2.5å¯¸å››é€š2é˜€æ•´å¥—</td>
        <td>å¥—</td>
        <td>49</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q7" min="0" value="0" disabled></td>
        <td id="s7">0.0</td>
    </tr>
    <tr class="ditou" id="aluminumPlugTr">
        <td>åœ°å¤´å¿…å¤‡</td>
        <td>3å¯¸å µå¤´(é“)</td>
        <td>ä¸ª</td>
        <td>4.5</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q9" min="0" value="0" disabled></td>
        <td id="s9">0.0</td>
    </tr>
    <!-- å¤‡ç”¨ä»¶ - æ­£å¸¸ä»¶ -->
    <tr class="beiyong" id="rubberJointTr">
        <td>å¤‡ç”¨ä»¶</td>
        <td>2.5å¯¸èƒ¶å¯¹æ¥å¤´</td>
        <td>å¥—</td>
        <td>2</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q11" min="0" value="0" disabled></td>
        <td id="s11">0.0</td>
    </tr>
    <tr class="beiyong" id="rubberGasketTr">
        <td>å¤‡ç”¨ä»¶</td>
        <td>2.5å¯¸å†…å«(å¯†å°åœˆ)</td>
        <td>ä¸ª</td>
        <td>0.7</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q12" min="0" value="0" disabled></td>
        <td id="s12">0.0</td>
    </tr>
    <tr class="beiyong" id="clampTr">
        <td>å¤‡ç”¨ä»¶</td>
        <td>2.5å¯¸å¡ç®</td>
        <td>ä¸ª</td>
        <td>0.4</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q10" min="0" value="0" disabled></td>
        <td id="s10">0.0</td>
    </tr>
    <!-- éšè—ä»¶ - åœ°å¤´å¿…å¤‡ -->
    <tr class="custom-item ditou" id="fourWay3ValveTr">
        <td>åœ°å¤´å¿…å¤‡</td>
        <td>2.5å¯¸å››é€š3é˜€æ•´å¥—</td>
        <td>å¥—</td>
        <td>49</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q13" min="0" value="0" disabled></td>
        <td id="s13">0.0</td>
    </tr>
    <tr class="custom-item ditou" id="threeWay3ValveTr">
        <td>åœ°å¤´å¿…å¤‡</td>
        <td>3å¯¸å››é€š3é˜€æ•´å¥—</td>
        <td>å¥—</td>
        <td>59</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q14" min="0" value="0" disabled></td>
        <td id="s14">0.0</td>
    </tr>
    <!-- éšè—ä»¶ - ä¸»ç®¡ç±» -->
    <tr class="custom-item ditou" id="bigMainPipe25Tr">
        <td>åœ°å¤´å¿…å¤‡</td>
        <td>2.5å¯¸ä¸»ç®¡100ç±³(ä¸å¸¦é…ä»¶)</td>
        <td>ç›˜</td>
        <td>200</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q23" min="0" value="0" disabled></td>
        <td id="s23">0.0</td>
    </tr>
    <tr class="custom-item ditou" id="bigMainPipe3Tr">
        <td>åœ°å¤´å¿…å¤‡</td>
        <td>3å¯¸ä¸»ç®¡100ç±³(ä¸å¸¦é…ä»¶)</td>
        <td>ç›˜</td>
        <td>270</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q24" min="0" value="0" disabled></td>
        <td id="s24">0.0</td>
    </tr>
    <tr class="custom-item ditou" id="bigMainPipe4Tr">
        <td>åœ°å¤´å¿…å¤‡</td>
        <td>4å¯¸ä¸»ç®¡100ç±³(ä¸å¸¦é…ä»¶)</td>
        <td>ç›˜</td>
        <td>340</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q25" min="0" value="0" disabled></td>
        <td id="s25">0.0</td>
    </tr>
    <!-- éšè—ä»¶ - åœ°é‡Œå¿…å¤‡ -->
    <tr class="custom-item dili" id="controlValveTr">
        <td>åœ°é‡Œå¿…å¤‡</td>
        <td>æ§åˆ¶é˜€é—¨åŠ çŸ­æ¥</td>
        <td>ä¸ª</td>
        <td>5</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q21" min="0" value="0" disabled></td>
        <td id="s21">0.0</td>
    </tr>
    <tr class="custom-item dili" id="longPipeTr">
        <td>åœ°é‡Œå¿…å¤‡</td>
        <td>2.5å¯¸æ”¯ç®¡50ç±³(ä¸å¸¦é…ä»¶)</td>
        <td>ç›˜</td>
        <td>100</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q22" min="0" value="0" disabled></td>
        <td id="s22">0.0</td>
    </tr>
    <tr class="custom-item dili" id="waterNeedleTr">
        <td>åœ°é‡Œå¿…å¤‡</td>
        <td>å–·å¤´åˆ†æ°´é’ˆ</td>
        <td>ä¸ª</td>
        <td>1.5</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q18" min="0" value="0" disabled></td>
        <td id="s18">0.0</td>
    </tr>
    <!-- éšè—ä»¶ - å¤‡ç”¨ä»¶ -->
    <tr class="custom-item beiyong" id="aluminumJointTr">
        <td>å¤‡ç”¨ä»¶</td>
        <td>3å¯¸å¯¹æ¥å¤´(é“)</td>
        <td>å¥—</td>
        <td>7</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q15" min="0" value="0" disabled></td>
        <td id="s15">0.0</td>
    </tr>
    <tr class="custom-item beiyong" id="bigGasketTr">
        <td>å¤‡ç”¨ä»¶</td>
        <td>3å¯¸å†…å«(å¯†å°åœˆ)</td>
        <td>ä¸ª</td>
        <td>0.7</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q17" min="0" value="0" disabled></td>
        <td id="s17">0.0</td>
    </tr>
    <tr class="custom-item beiyong" id="bigClampTr">
        <td>å¤‡ç”¨ä»¶</td>
        <td>3å¯¸å¡ç®</td>
        <td>ä¸ª</td>
        <td>0.5</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q26" min="0" value="0" disabled></td>
        <td id="s26">0.0</td>
    </tr>
    <tr class="custom-item beiyong" id="2to3JointTr">
        <td>å¤‡ç”¨ä»¶</td>
        <td>2.5å˜3å¯¸å¯¹æ¥å¤´(é“)</td>
        <td>å¥—</td>
        <td>6</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q16" min="0" value="0" disabled></td>
        <td id="s16">0.0</td>
    </tr>
    <tr class="custom-item beiyong" id="4to3JointTr">
        <td>å¤‡ç”¨ä»¶</td>
        <td>4å¯¸å˜3å¯¸å¯¹æ¥å¤´(é“)</td>
        <td>å¥—</td>
        <td>10</td>
        <td><input type="number" class="qty-input" oninput="calcTotal(false);recordCustomItemQty(this)" id="q27" min="0" value="0" disabled></td>
        <td id="s27">0.0</td>
    </tr>
    <!-- æ€»ä»·è¡Œ -->
    <tr class="total">
        <td colspan="5">æœªå‡å…æ€»ä»·</td>
        <td id="originalTotal">0.0</td>
    </tr>
    <!-- ä¼˜æƒ å‡å…è¡Œ -->
    <tr class="discount-row">
        <td colspan="5">ä¼˜æƒ å‡å…</td>
        <td id="discountTotal">-0.0</td>
    </tr>
    <!-- æœ€ç»ˆæ€»ä»·è¡Œ -->
    <tr class="final-total">
        <td colspan="5">æœ€ç»ˆåº”ä»˜é‡‘é¢</td>
        <td id="finalTotal">0.0</td>
    </tr>
</table>
            <!-- ä¸‹è½½æŒ‰é’®æ”¾åœ¨è¡¨æ ¼ä¸‹æ–¹ï¼ˆåŸæç¤ºæ–‡å­—ä½ç½®ï¼‰ -->
<div style="text-align: center; margin: 20px 0;">
    <button class="btn" style="background: #3498db; padding: 12px; font-size: 15px; width: 80%;" id="downloadTableBtn">ğŸ“¥ ä¸‹è½½ç‰©æ–™æ¸…å•æˆªå›¾</button>
</div>
        </div>
    </div>
    <div class="modal-mask" id="clearModal">
        <div class="modal-box">
            <div class="modal-title">ç¡®è®¤æ¸…ç©ºå†å²è®°å½•ï¼Ÿ</div>
            <p style="color:#7f8c8d;margin-bottom:20px;font-size:14px;">æ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ</p>
            <div class="modal-btn-group">
                <button class="modal-btn modal-confirm" id="confirmClearBtn">ç¡®è®¤æ¸…ç©º</button>
                <button class="modal-btn modal-cancel" id="cancelClearBtn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
        <script>
        const SYMMETRY_THRESHOLD = 240;
        const PRICE_MAP = {
    nozzle: { four12:20, four15:22, sand12:18, sand15:20, custom12:20, custom15:22 },
    pipe: { eightM:26, sixteenM:39, fiveM:14, tenM:27, mainSixteenM:62, mainTenM:43 },
    common: {
        q4:0.8, q5:1.5, q6:39, q7:49, q9:4.5, q10:0.4, q11:2, q12:0.7,
        q13:49, q14:59, q15:7, q16:6, q17:0.7, q18:1.5, q19:6, q20:10, // ä¿®æ­£ï¼šq15=7ï¼ˆ3å¯¸å¯¹æ¥å¤´ï¼‰ï¼Œq16=6ï¼ˆ2.5å˜3å¯¸æ¥å¤´ï¼‰
        q21:5, q22:100, q23:200, q24:270, q25:340, q26:0.5 // q26=0.5ï¼ˆ3å¯¸å¡ç®ï¼‰
    }
};
        
        let currentNozzleType = "four", currentNozzleSize = "1.2", isEdit = false, isCustomShow = false;
        let historyList = JSON.parse(localStorage.getItem('calcHistory')) || []; 
        let currentDiscount = 0;
        // å­˜å‚¨æœ‰æ•°é‡çš„é…ä»¶IDï¼ˆä¸ç®¡æ˜¯customè¿˜æ˜¯hideï¼‰
        let hasQtyItemIds = [];
        
        // DOMå…ƒç´ è·å–ï¼ˆåŒ…å«æ‰€æœ‰éœ€è¦æ§åˆ¶çš„hide-itemï¼‰
        const el = {
            nozzleType: document.getElementById('nozzleType'),
            gun12Switch: document.getElementById('gun12Switch'),
            gun15Switch: document.getElementById('gun15Switch'),
            nozzleName: document.getElementById('nozzleName'),
            nozzlePrice: document.getElementById('nozzlePrice'),
            nozzleDiameter: document.getElementById('nozzleDiameter'),
            colGap: document.getElementById('colGap'),
            plotLength: document.getElementById('plotLength'),
            plotWidth: document.getElementById('plotWidth'),
            calcBtn: document.getElementById('calcBtn'),
            result: document.getElementById('result'),
            param: document.getElementById('param'),
            originalTotal: document.getElementById('originalTotal'),
            discountTotal: document.getElementById('discountTotal'),
            finalTotal: document.getElementById('finalTotal'),
            discountAmount: document.getElementById('discountAmount'),
            applyDiscountBtn: document.getElementById('applyDiscountBtn'),
            editSwitch: document.getElementById('editSwitch'),
            editText: document.getElementById('editText'),
            customSwitch: document.getElementById('customSwitch'),
            customText: document.getElementById('customText'),
            historyPanel: document.getElementById('historyPanel'),
            toggleHistoryBtn: document.getElementById('toggleHistoryBtn'),
            clearHistoryBtn: document.getElementById('clearHistoryBtn'),
            clearModal: document.getElementById('clearModal'),
            confirmClearBtn: document.getElementById('confirmClearBtn'),
            cancelClearBtn: document.getElementById('cancelClearBtn'),
            // æ‰€æœ‰æ ¸å¿ƒhide-item
            threeWayTr: document.getElementById('threeWayTr'),
            fourWayTr: document.getElementById('fourWayTr'),
            pipe8mTr: document.getElementById('pipe8mTr'),
            pipe16mTr: document.getElementById('pipe16mTr'),
            pipe5mTr: document.getElementById('pipe5mTr'),
            pipe10mTr: document.getElementById('pipe10mTr'),
            main16mTr: document.getElementById('main16mTr'),
            main10mTr: document.getElementById('main10mTr'),
            waterNeedleSpareTr: document.getElementById('waterNeedleSpareTr')
        };
        
        // æ‰€æœ‰éœ€è¦æ§åˆ¶æ˜¾ç¤ºçš„hide-itemé›†åˆï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰
        const allHideItems = [
            el.pipe8mTr, el.pipe16mTr, el.pipe5mTr, el.pipe10mTr,
            el.main16mTr, el.main10mTr, el.threeWayTr, el.fourWayTr
        ];
        
        // æ‰€æœ‰custom-itemé›†åˆ
        const allCustomItems = document.querySelectorAll('.custom-item');
        
        // æ ¸å¿ƒä¿®å¤ï¼šæ•°é‡å˜åŒ–æ—¶ç›´æ¥ç¡¬æ§æ˜¾ç¤ºï¼Œä¸ä¾èµ–class
        function recordCustomItemQty(input) {
    const itemRow = input.closest('tr');
    const qty = parseFloat(input.value) || 0;
    // åªè¦æ•°é‡>0ï¼Œå¼ºåˆ¶æ˜¾ç¤ºï¼›æ•°é‡=0ï¼Œä¹Ÿä¸éšè—ï¼ˆé¿å…æ¶ˆå¤±ï¼‰
    itemRow.style.display = 'table-row !important';
}
        
        // åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰å–·å¤´ç±»å‹çš„æ ¸å¿ƒç‰©æ–™
        function checkIsCoreItem(itemId) {
            if (currentNozzleType === "four") {
                return ['pipe8mTr', 'pipe16mTr', 'main16mTr', 'threeWayTr', 'fourWayTr'].includes(itemId);
            } else if (currentNozzleType === "sand") {
                return ['pipe5mTr', 'pipe10mTr', 'main10mTr', 'threeWayTr', 'fourWayTr'].includes(itemId);
            } else if (currentNozzleType === "custom") {
                return ['threeWayTr', 'fourWayTr'].includes(itemId);
            }
            return false;
        }
        
        // é‡ç½®æ˜¾ç¤ºï¼šä¸ç®¡ä»€ä¹ˆçŠ¶æ€ï¼Œå…ˆæŒ‰è§„åˆ™åˆå§‹åŒ–ï¼Œå†å¼ºåˆ¶æ˜¾ç¤ºæœ‰æ•°é‡çš„
        function resetAllItemsDisplay() {
    // åˆå§‹åŒ–hide-itemï¼šæ ¸å¿ƒç‰©æ–™æ˜¾ç¤ºï¼Œéæ ¸å¿ƒé»˜è®¤éšè—
    allHideItems.forEach(item => {
        item.style.display = checkIsCoreItem(item.id) ? 'table-row' : 'none';
    });
    
    // åˆå§‹åŒ–custom-itemï¼šé»˜è®¤éšè—
    allCustomItems.forEach(item => {
        item.style.display = 'none';
    });
    
    // å…³é”®é€»è¾‘ï¼šæœ‰æ•°é‡çš„é…ä»¶ï¼Œå¼ºåˆ¶æ˜¾ç¤ºï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼Œè¦†ç›–æ‰€æœ‰éšè—è§„åˆ™ï¼‰
    hasQtyItemIds.forEach(itemId => {
        const item = document.getElementById(itemId);
        if (item) item.style.display = 'table-row !important';
    });
    
    // æ˜¾ç¤ºæ‰€æœ‰é…ä»¶æ—¶ï¼Œå¼ºåˆ¶å…¨éƒ¨æ˜¾ç¤º
    if (isCustomShow) {
        allHideItems.forEach(item => item.style.display = 'table-row');
        allCustomItems.forEach(item => item.style.display = 'table-row');
    }
}
        
        // å–·å¤´ç±»å‹å˜æ›´å¤„ç†
        function handleNozzleTypeChange() {
            currentNozzleType = el.nozzleType.value;
            switch(currentNozzleType) {
                case "four":
                    el.nozzleDiameter.value = 16;
                    el.colGap.value = 16;
                    el.nozzleDiameter.disabled = true;
                    el.colGap.disabled = true;
                    break;
                case "sand":
                    el.nozzleDiameter.value = 10;
                    el.colGap.value = 10;
                    el.nozzleDiameter.disabled = true;
                    el.colGap.disabled = true;
                    break;
                case "custom":
                    el.nozzleDiameter.disabled = false;
                    el.colGap.disabled = false;
                    if (!isEdit) toggleEdit();
                    break;
            }
            updateNozzleInfo();
            resetAllItemsDisplay(); // é‡æ–°åˆå§‹åŒ–æ˜¾ç¤º
            if (el.result.style.display === "block") calcTotal(true);
        }
        
        // åˆ‡æ¢æ˜¾ç¤ºæ‰€æœ‰é…ä»¶ï¼ˆå½»åº•æ”¹å†™ï¼‰
        function toggleCustom() {
    isCustomShow = !isCustomShow;
    // å¼€å…³åªéšè—â€œæ•°é‡ä¸º0â€çš„éšè—é…ä»¶
    document.querySelectorAll('.custom-item, .hide-item').forEach(item => {
        const qty = parseFloat(item.querySelector('.qty-input').value) || 0;
        item.style.display = qty > 0 ? 'table-row !important' : (isCustomShow ? 'table-row' : 'none');
    });
    el.customText.innerText = isCustomShow ? 'éšè—é¢å¤–é…ä»¶' : 'æ˜¾ç¤ºæ‰€æœ‰é…ä»¶';
    el.customSwitch.classList.toggle('active', isCustomShow);
}
        
        // æ˜¾ç¤ºæ‰€æœ‰ç‰©æ–™ï¼ˆç”¨äºåˆå§‹åŒ–ï¼‰
        function showAllItems() {
            allHideItems.forEach(item => item.style.display = 'table-row');
            allCustomItems.forEach(item => item.style.display = 'table-row');
        }
        
        // æ•°å€¼å–æ•´ä¸º5æˆ–10çš„å€æ•°
        function to5or10(num) {
            let ceilNum = Math.ceil(num);
            return ceilNum <= 5 ? 5 : Math.ceil(ceilNum / 10) * 10;
        }
        
        // è®¡ç®—2.5å¯¸å µå¤´æ•°é‡
        function calc25Dutou(baseNum) {
            if (baseNum < 5) return baseNum;
            let div = baseNum / 5, y = Math.floor(div), tail = div - y;
            return baseNum + (tail >= 0.5 ? y + 1 : y);
        }
        
        // è®¡ç®—3å¯¸å µå¤´æ•°é‡
        function calc3Dutou(wid, colNum) {
            return colNum < 2 ? 0 : 1 + Math.floor(wid / 65);
        }
        
        // è®¡ç®—å–·å¤´å¸ƒå±€
        function calcNozzleLayout(X, nozzleGap) {
            const isSymmetry = X > SYMMETRY_THRESHOLD;
            const halfX = isSymmetry ? X / 2 : X;
            const division = halfX / nozzleGap;
            const divisionFixed = division.toFixed(3);
            const y = Math.floor(division);
            const tailRaw = division - y;
            
            let oddNum, evenNum;
            if (tailRaw === 0) {
                oddNum = y || 1;
                evenNum = (y + 1) || 1;
            } else if (tailRaw > 0 && tailRaw <= 0.5) {
                oddNum = y + 1;
                evenNum = y + 1;
            } else if (tailRaw > 0.5 && tailRaw < 1) {
                oddNum = y + 1;
                evenNum = y + 2;
            } else {
                oddNum = y || 1;
                evenNum = (y + 1) || 1;
            }
            const calcStr = isSymmetry 
                ? `${X}Ã·2Ã·${nozzleGap}=${divisionFixed} | å•†=${y} | å°¾æ•°=${tailRaw.toFixed(3)}` 
                : `${X}Ã·${nozzleGap}=${divisionFixed} | å•†=${y} | å°¾æ•°=${tailRaw.toFixed(3)}`;
            return { isSymmetry, halfX, tail: tailRaw, y, odd: { num: oddNum }, even: { num: evenNum }, calcStr };
        }
        
        // è®¡ç®—å®½åº¦å¸ƒå±€
        function calcWidthLayout(widthVal, colGapVal) {
            const division = widthVal / colGapVal;
            const divisionFixed = division.toFixed(3);
            const y = Math.floor(division);
            const tail = (division - y).toFixed(3);
            const calcStr = `${widthVal}Ã·${colGapVal}=${divisionFixed} | å•†=${y} | å°¾æ•°=${tail}`;
            return { calcStr, divisionFixed, y, tail: division - y };
        }
        
        // è®¡ç®—åˆ—æ•°
        function calcPipeNum(widthVal, colGapVal) {
            let div = widthVal / colGapVal;
            return div === Math.floor(div) ? div : Math.floor(div) + 1 || 1;
        }
        
        // è®¡ç®—çŸ­æ”¯ç®¡æ•°é‡
        function calcShortBranch(tail, pipeNum, evenColNum, isSplit) {
            let num = 0;
            if (tail === 0) num = pipeNum + evenColNum * 2;
            else if (tail > 0 && tail <= 0.5) num = pipeNum * 2;
            else if (tail > 0.5 && tail < 1) num = pipeNum + evenColNum * 2;
            num = Math.max(num, 1);
            return isSplit ? num * 2 : num;
        }
        
        // åˆ‡æ¢ä¸‰é€š/å››é€šæ˜¾ç¤ºï¼ˆå…¼å®¹æ–°é€»è¾‘ï¼‰
        function toggleThreeFourWay(isSplit) {
            if (isSplit) {
                el.threeWayTr.style.display = isCustomShow ? 'table-row' : 'none';
                el.fourWayTr.style.display = 'table-row';
            } else {
                el.threeWayTr.style.display = 'table-row';
                el.fourWayTr.style.display = isCustomShow ? 'table-row' : 'none';
            }
            // æœ‰æ•°é‡åˆ™å¼ºåˆ¶æ˜¾ç¤º
            if (hasQtyItemIds.includes('threeWayTr')) el.threeWayTr.style.display = 'table-row !important';
            if (hasQtyItemIds.includes('fourWayTr')) el.fourWayTr.style.display = 'table-row !important';
        }
        
        // é€‰æ‹©å–·å¤´å°ºå¯¸
        function chooseNozzleSize(size) {
            currentNozzleSize = size;
            if (size === "1.2") {
                el.gun12Switch.classList.add('active');
                el.gun15Switch.classList.remove('active');
            } else {
                el.gun12Switch.classList.remove('active');
                el.gun15Switch.classList.add('active');
            }
            updateNozzleInfo();
            if (el.result.style.display === "block") calcTotal(true);
        }
        
        // æ›´æ–°å–·å¤´åç§°å’Œå•ä»·
        function updateNozzleInfo() {
            const nozzleKey = `${currentNozzleType}${currentNozzleSize.replace('.', '')}`;
            const nozzlePrice = PRICE_MAP.nozzle[nozzleKey] || 20;
            el.nozzleName.innerText = `${currentNozzleSize}ç±³${currentNozzleType === "four" ? "å››å˜´å–·å¤´æ•´å¥—" : currentNozzleType === "sand" ? "é˜²æ²™å–·å¤´æ•´å¥—" : "è‡ªå®šä¹‰å–·å¤´æ•´å¥—"}`;
            el.nozzlePrice.innerText = nozzlePrice;
        }
        
        // åˆ‡æ¢æ•°é‡ç¼–è¾‘çŠ¶æ€
        function toggleEdit() {
            isEdit = !isEdit;
            document.querySelectorAll('.qty-input').forEach(input => input.disabled = !isEdit);
            el.editSwitch.classList.toggle('active', isEdit);
            el.editText.innerText = isEdit ? 'é”å®šæ•°é‡' : 'è§£é”æ•°é‡';
        }
        
        // åˆ‡æ¢å†å²è®°å½•é¢æ¿
        function toggleHistory() {
            el.historyPanel.classList.toggle('show');
            if (el.historyPanel.classList.contains('show')) renderHistoryList();
        }
        
        // ä¿å­˜å†å²è®°å½•
        function saveHistory(num1, num2, totalPrice) {
            const now = new Date();
            const timeStr = `${now.getMonth() + 1}-${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            const sortedNum1 = Math.max(num1, num2);
            const sortedNum2 = Math.min(num1, num2);
            const nozzleDesc = `${currentNozzleSize}ç±³${currentNozzleType === "four" ? "å››å˜´" : currentNozzleType === "sand" ? "é˜²æ²™" : "è‡ªå®šä¹‰"}å–·å¤´`;
            const item = { num1: sortedNum1, num2: sortedNum2, totalPrice, timeStr, nozzleDesc };
            
            const idx = historyList.findIndex(i => i.num1 === sortedNum1 && i.num2 === sortedNum2 && i.nozzleDesc === nozzleDesc);
            if (idx > -1) {
                historyList[idx].totalPrice = totalPrice;
                historyList[idx].timeStr = timeStr;
            } else {
                historyList.unshift(item);
                if (historyList.length > 5) historyList.pop();
            }
            
            localStorage.setItem('calcHistory', JSON.stringify(historyList));
            if (el.historyPanel.classList.contains('show')) renderHistoryList();
        }
        
        // æ¸²æŸ“å†å²è®°å½•
        function renderHistoryList() {
            if (historyList.length === 0) {
                el.historyPanel.innerHTML = '<div class="history-item">æš‚æ— å†å²è®°å½•</div>';
                return;
            }
            
            let html = '';
            historyList.forEach((item, idx) => {
                html += `<div class="history-item" data-index="${idx}">
                    <span>${item.num1}Ã—${item.num2}m</span>
                    <span>|</span>
                    <span>${item.nozzleDesc}</span>
                    <span>|</span>
                    <span>æ€»ä»·${item.totalPrice}</span>
                    <div class="history-time">${item.timeStr}</div>
                </div>`;
            });
            el.historyPanel.innerHTML = html;
            
            document.querySelectorAll('.history-item').forEach(item => {
                item.addEventListener('click', () => loadHistory(item.dataset.index));
            });
        }
        
        // åŠ è½½å†å²è®°å½•
        function loadHistory(idx) {
            const item = historyList[idx];
            el.plotLength.value = item.num1;
            el.plotWidth.value = item.num2;
            
            if (item.nozzleDesc.includes('å››å˜´')) el.nozzleType.value = 'four';
            else if (item.nozzleDesc.includes('é˜²æ²™')) el.nozzleType.value = 'sand';
            else el.nozzleType.value = 'custom';
            handleNozzleTypeChange();
            
            chooseNozzleSize(item.nozzleDesc.includes('1.2') ? '1.2' : '1.5');
            
            calc();
            toggleHistory();
        }
        
        // æ˜¾ç¤ºæ¸…ç©ºç¡®è®¤å¼¹çª—
        function showClearModal() {
            historyList = JSON.parse(localStorage.getItem('calcHistory')) || [];
            if (historyList.length === 0) {
                alert('æ— è®°å½•å¯æ¸…');
                return;
            }
            el.clearModal.style.display = 'flex';
        }
        
        // éšè—æ¸…ç©ºç¡®è®¤å¼¹çª—
        function hideClearModal() {
            el.clearModal.style.display = 'none';
        }
        
        // ç¡®è®¤æ¸…ç©ºå†å²è®°å½•
        function confirmClear() {
            historyList = [];
            localStorage.removeItem('calcHistory');
            if (el.historyPanel.classList.contains('show')) renderHistoryList();
            hideClearModal();
            alert('è®°å½•å·²æ¸…ç©º');
        }
        // ===================== æ–°å¢ï¼šé…ç½®æŒä¹…åŒ–+å›è½¦è§¦å‘ ç›¸å…³å¸¸é‡ =====================
const CONFIG_KEY = "sprinklerAppConfig";
const configFields = {
  plotLength: { type: "input", selector: "#plotLength" },
  plotWidth: { type: "input", selector: "#plotWidth" },
  nozzleType: { type: "select", selector: "#nozzleType" },
  gun12Switch: { type: "switch", selector: "#gun12Switch" },
  gun15Switch: { type: "switch", selector: "#gun15Switch" },
  nozzleDiameter: { type: "input", selector: "#nozzleDiameter" },
  colGap: { type: "input", selector: "#colGap" },
  discountAmount: { type: "input", selector: "#discountAmount" }
};

// ===================== æ–°å¢ï¼šé…ç½®æŒä¹…åŒ–åŠŸèƒ½ï¼ˆåˆ·æ–°ä¸ä¸¢æ•°æ®ï¼‰ =====================
function saveConfig() {
  const config = {};
  Object.keys(configFields).forEach(key => {
    const field = configFields[key];
    const element = document.querySelector(field.selector);
    if (!element) return;
    if (field.type === "input") config[key] = element.value;
    else if (field.type === "select") config[key] = element.value;
    else if (field.type === "switch") config[key] = element.classList.contains("active");
  });
  // æ–°å¢ï¼šä¿å­˜â€œæ˜¯å¦å·²ç»è®¡ç®—è¿‡â€çš„çŠ¶æ€
  config.hasCalculated = el.result.style.display === "block";
  localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
}

function loadConfig() {
  const savedConfig = localStorage.getItem(CONFIG_KEY);
  if (savedConfig) {
    const config = JSON.parse(savedConfig);
    Object.keys(configFields).forEach(key => {
      const field = configFields[key];
      const element = document.querySelector(field.selector);
      if (!element || config[key] === undefined) return;
      if (field.type === "input") element.value = config[key];
      else if (field.type === "select") {
        element.value = config[key];
        handleNozzleTypeChange();
      } else if (field.type === "switch") {
        if (key === "gun12Switch" && config[key]) chooseNozzleSize("1.2");
        if (key === "gun15Switch" && config[key]) chooseNozzleSize("1.5");
      }
    });
    // å…³é”®ï¼šå¦‚æœä¹‹å‰è®¡ç®—è¿‡ï¼Œåˆ·æ–°åè‡ªåŠ¨é‡æ–°è®¡ç®—ï¼ˆå›¾è¡¨å°±å‡ºæ¥äº†ï¼‰
    if (config.hasCalculated && config.plotLength && config.plotWidth) {
      setTimeout(calc, 300); // å»¶è¿Ÿä¸€ç‚¹æ‰§è¡Œï¼Œç¡®ä¿é¡µé¢åŠ è½½å®Œ
    }
  } else {
    // æ— é…ç½®æ—¶æ˜¾ç¤ºé»˜è®¤å€¼
    document.getElementById('plotLength').value = "200";
    document.getElementById('plotWidth').value = "48";
    document.getElementById('nozzleDiameter').value = "16";
    document.getElementById('colGap').value = "16";
    el.nozzleType.value = "four";
    chooseNozzleSize("1.2");
  }
}

function initConfigPersistence() {
  window.addEventListener("load", loadConfig);
  Object.keys(configFields).forEach(key => {
    const field = configFields[key];
    const element = document.querySelector(field.selector);
    if (!element) return;
    // è¾“å…¥æ—¶å®æ—¶ä¿å­˜ï¼Œç¡®ä¿æ¯æ”¹ä¸€ä¸ªå­—éƒ½å­˜ä¸‹æ¥
    if (field.type === "input" || field.type === "select") {
      element.addEventListener("input", saveConfig);
      element.addEventListener("change", saveConfig);
    } else if (field.type === "switch") {
      element.addEventListener("click", saveConfig);
    }
  });
  // è®¡ç®—æŒ‰é’®ç‚¹å‡»æ—¶ä¿å­˜ï¼ŒåŒæ—¶æ ‡è®°â€œå·²è®¡ç®—â€
  el.calcBtn.addEventListener("click", function() {
    el.result.style.display = "block"; // æ ‡è®°ä¸ºå·²è®¡ç®—
    saveConfig(); // ä¿å­˜çŠ¶æ€
  });
}

// ===================== æ–°å¢ï¼šä»…é•¿å®½è¾“å…¥æ¡†å›è½¦è§¦å‘ç”Ÿæˆ =====================
function initEnterGenerateOnlyInSizeInputs() {
  const lengthInput = document.getElementById('plotLength');
  const widthInput = document.getElementById('plotWidth');
  const calcBtn = document.getElementById('calcBtn');
  [lengthInput, widthInput].forEach(input => {
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        calcBtn.click();
      }
    });
  });
  document.addEventListener('keydown', function(e) {
    const activeElement = document.activeElement;
    if (e.key === 'Enter' && activeElement !== lengthInput && activeElement !== widthInput) {
      e.preventDefault();
    }
  }, { capture: true });
}
        
        // åº”ç”¨ä¼˜æƒ å‡å…
        function applyDiscount() {
            const discount = parseFloat(el.discountAmount.value) || 0;
            const originalTotal = parseFloat(el.originalTotal.innerText) || 0;
            
            if (discount < 0) {
                alert('å‡å…é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°');
                el.discountAmount.value = 0;
                currentDiscount = 0;
            } else if (discount > originalTotal) {
                alert(`å‡å…é‡‘é¢ä¸èƒ½è¶…è¿‡æœªå‡å…æ€»ä»·ï¼ˆ${originalTotal}å…ƒï¼‰`);
                el.discountAmount.value = originalTotal;
                currentDiscount = originalTotal;
            } else {
                currentDiscount = discount;
            }
            
            el.discountTotal.innerText = `-${currentDiscount.toFixed(1)}`;
            const finalTotal = (originalTotal - currentDiscount).toFixed(1) + "å…ƒ";
            el.finalTotal.innerText = finalTotal;
            
            if (el.result.style.display === "block") {
                const X = Number(el.plotLength.value);
                const widthVal = Number(el.plotWidth.value);
                saveHistory(X, widthVal, finalTotal);
            }
        }
        
        // è®¡ç®—æ€»ä»·
function calcTotal(isApplyDiscount = true) {
    let total = 0;
    
    document.querySelectorAll('[id^="s"]').forEach(el => {
        if (el.id !== 'originalTotal' && el.id !== 'discountTotal' && el.id !== 'finalTotal') {
            el.innerText = '0.0';
        }
    });
    
    // å–·å¤´æ€»ä»·
    const nozzleQty = parseFloat(document.getElementById('q1').value) || 0;
    const nozzleUnitPrice = parseFloat(el.nozzlePrice.innerText) || 0;
    const nozzleTotal = (nozzleQty * nozzleUnitPrice).toFixed(1);
    document.getElementById('s1').innerText = nozzleTotal;
    total += parseFloat(nozzleTotal);
    
    // ç®¡å­æ€»ä»·ï¼ˆå››å˜´+é˜²æ²™ä¸“å±ï¼‰
    const q2 = parseFloat(document.getElementById('q2').value) || 0;
    const s2 = (q2 * PRICE_MAP.pipe.eightM).toFixed(1);
    document.getElementById('s2').innerText = s2;
    total += parseFloat(s2);
    
    const q3 = parseFloat(document.getElementById('q3').value) || 0;
    const s3 = (q3 * PRICE_MAP.pipe.sixteenM).toFixed(1);
    document.getElementById('s3').innerText = s3;
    total += parseFloat(s3);
    
    const q_s5 = parseFloat(document.getElementById('q_s5').value) || 0;
    const s_s5 = (q_s5 * PRICE_MAP.pipe.fiveM).toFixed(1);
    document.getElementById('s_s5').innerText = s_s5;
    total += parseFloat(s_s5);
    
    const q_s10 = parseFloat(document.getElementById('q_s10').value) || 0;
    const s_s10 = (q_s10 * PRICE_MAP.pipe.tenM).toFixed(1);
    document.getElementById('s_s10').innerText = s_s10;
    total += parseFloat(s_s10);
    
    const q8 = parseFloat(document.getElementById('q8').value) || 0;
    const s8 = (q8 * PRICE_MAP.pipe.mainSixteenM).toFixed(1);
    document.getElementById('s8').innerText = s8;
    total += parseFloat(s8);
    
    const q_s3 = parseFloat(document.getElementById('q_s3').value) || 0;
    const s_s3 = (q_s3 * PRICE_MAP.pipe.mainTenM).toFixed(1);
    document.getElementById('s_s3').innerText = s_s3;
    total += parseFloat(s_s3);
    
    // é€šç”¨ç‰©æ–™+éšè—ä»¶æ€»ä»·ï¼ˆéå†æ‰€æœ‰qty-inputï¼Œç¡®ä¿æ— é—æ¼ï¼‰
    document.querySelectorAll('.qty-input').forEach(input => {
        const qtyId = input.id;
        // è·³è¿‡å·²å•ç‹¬ç»Ÿè®¡çš„é…ä»¶ï¼Œé¿å…é‡å¤è®¡ç®—
        if (['q1', 'q2', 'q3', 'q_s5', 'q_s10', 'q8', 'q_s3'].includes(qtyId)) return;
        
        const sId = qtyId.startsWith('q_s') ? `s${qtyId.replace('q_', '')}` : `s${qtyId.replace('q', '')}`;
        const sEl = document.getElementById(sId);
        if (!sEl) return;
        
        let unitPrice = PRICE_MAP.common[qtyId] || 0;
        if (unitPrice === 0) {
            const priceCell = input.closest('tr').querySelector('td:nth-child(4)');
            unitPrice = parseFloat(priceCell.innerText) || 0;
        }
        
        const qty = parseFloat(input.value) || 0;
        const subtotal = (qty * unitPrice).toFixed(1);
        sEl.innerText = subtotal;
        total += parseFloat(subtotal);
    });
    
    const originalTotalStr = total.toFixed(1);
    el.originalTotal.innerText = originalTotalStr;
    
    if (isApplyDiscount) {
        applyDiscount();
    } else {
        el.discountTotal.innerText = `-${currentDiscount.toFixed(1)}`;
        const finalTotal = (parseFloat(originalTotalStr) - currentDiscount).toFixed(1);
        el.finalTotal.innerText = finalTotal;
    }
    
    return el.finalTotal.innerText;
}
        
        // æ ¸å¿ƒè®¡ç®—é€»è¾‘
        function calc() {
            const X = Number(el.plotLength.value);
            const widthVal = Number(el.plotWidth.value);
            const colGapVal = Number(el.colGap.value);
            const nozzleGapVal = Number(el.nozzleDiameter.value);
            
            if (!X || !widthVal || !colGapVal || !nozzleGapVal || X <=0 || widthVal <=0 || colGapVal <=0 || nozzleGapVal <=0) {
                alert('è¯·å¡«å†™æœ‰æ•ˆçš„æ­£æ•°å€¼');
                return;
            }
            
            const nozzleLayout = calcNozzleLayout(X, nozzleGapVal);
            const widthLayout = calcWidthLayout(widthVal, colGapVal);
            const pipeNum = calcPipeNum(widthVal, colGapVal);
            const isSplit = nozzleLayout.isSymmetry;
            const oddColNum = Math.ceil(pipeNum / 2);
            const evenColNum = Math.floor(pipeNum / 2);
            const finalOddNum = isSplit ? nozzleLayout.odd.num * 2 : nozzleLayout.odd.num;
            const finalEvenNum = isSplit ? nozzleLayout.even.num * 2 : nozzleLayout.even.num;
            const totalNozzle = Math.max(0, (oddColNum * finalOddNum) + (evenColNum * finalEvenNum));
            
            const mat = {
                q1: totalNozzle,
                q4: to5or10(totalNozzle / 3),
                q5: calc25Dutou(isSplit ? pipeNum * 2 : pipeNum),
                q6: Math.max(0, (pipeNum >= 2 && !isSplit) ? pipeNum : 0),
                q7: Math.max(0, (pipeNum >= 2 && isSplit) ? pipeNum : 0),
                q9: calc3Dutou(widthVal, pipeNum),
                q10: to5or10(totalNozzle * 0.1) * 4,
                q11: to5or10(totalNozzle * 0.1),
                q12: to5or10(totalNozzle * 0.1) * 2,
                q13:0, q14:0, q15:0, q16:0, q17:0, q18:0, q19:0, q20:0,
                q21:0, q22:0, q23:0, q24:0, q25:0, q26:0,
                q2:0, q3:0, q8:0, q_s5:0, q_s10:0, q_s3:0
            };
            
            if (currentNozzleType === "four") {
                mat.q2 = calcShortBranch(nozzleLayout.tail, pipeNum, evenColNum, isSplit);
                mat.q3 = Math.max(0, totalNozzle - mat.q2);
                mat.q8 = Math.max(0, pipeNum >= 2 ? pipeNum : 0);
            } else if (currentNozzleType === "sand") {
                mat.q_s5 = calcShortBranch(nozzleLayout.tail, pipeNum, evenColNum, isSplit);
                mat.q_s10 = Math.max(0, totalNozzle - mat.q_s5);
                mat.q_s3 = Math.max(0, pipeNum >= 2 ? pipeNum : 0);
            }
            
            Object.keys(mat).forEach(key => {
                const inputEl = document.getElementById(key);
                if (inputEl) inputEl.value = mat[key];
            });
            
            toggleThreeFourWay(isSplit);
            resetAllItemsDisplay(); // è®¡ç®—åé‡ç½®æ˜¾ç¤ºï¼Œç¡®ä¿æœ‰æ•°é‡çš„é…ä»¶æ˜¾ç¤º
            
            el.param.innerHTML = `
                <p>âœ… åˆ†å—ï¼š${isSplit ? `æ˜¯(2å—ï¼Œå•å—${(X/2).toFixed(1)}m)` : 'å¦'}</p>
                <p>âœ… é•¿åº¦æ ¸ç®—ï¼š${nozzleLayout.calcStr}</p>
                <p>âœ… å®½åº¦æ ¸ç®—ï¼š${widthLayout.calcStr}</p>
                <p>âœ… åˆ—æ•°ï¼šå…±${pipeNum}åˆ—(å¥‡${oddColNum}/å¶${evenColNum})</p>
                <p>âœ… æ¯åˆ—å–·å¤´æ•°ï¼šå¥‡${finalOddNum}æ”¯ å¶${finalEvenNum}æ”¯ | æ€»å–·å¤´æ•°${totalNozzle}æ”¯</p>
                <p>âœ… å–·å¤´ï¼š${currentNozzleSize}ç±³${currentNozzleType === "four" ? "å››å˜´" : currentNozzleType === "sand" ? "é˜²æ²™" : "è‡ªå®šä¹‰"}</p>
            `;
            
            el.result.style.display = "block";
            el.result.scrollIntoView({ behavior: "smooth" });
            
            const totalPrice = calcTotal();
            saveHistory(X, widthVal, totalPrice);
        }
        
        // ç»‘å®šæ‰€æœ‰äº‹ä»¶ï¼ˆå¼ºåŒ–è¾“å…¥æ¡†ç›‘å¬ï¼‰
        function bindEvents() {
            el.nozzleType.addEventListener('change', handleNozzleTypeChange);
            
            document.querySelectorAll('.switch-wrap[data-size]').forEach(wrap => {
                wrap.addEventListener('click', () => chooseNozzleSize(wrap.dataset.size));
            });
            
            document.querySelectorAll('.switch-wrap[data-action]').forEach(wrap => {
                wrap.addEventListener('click', () => {
                    wrap.dataset.action === 'edit' ? toggleEdit() : toggleCustom();
                });
            });
            
            el.toggleHistoryBtn.addEventListener('click', toggleHistory);
            el.clearHistoryBtn.addEventListener('click', showClearModal);
            el.confirmClearBtn.addEventListener('click', confirmClear);
            el.cancelClearBtn.addEventListener('click', hideClearModal);
            
            el.calcBtn.addEventListener('click', calc);
            
            el.applyDiscountBtn.addEventListener('click', applyDiscount);
            el.discountAmount.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') applyDiscount();
            });
            
            // ä¸‰é‡äº‹ä»¶ç»‘å®šï¼Œç¡®ä¿æ•°é‡å˜åŒ–100%è§¦å‘
            document.querySelectorAll('.qty-input').forEach(input => {
            // ===== 1. æ–°å¢ï¼šå‰ç½®é›¶è¿‡æ»¤é€»è¾‘ï¼ˆæ”¾åœ¨inputäº‹ä»¶æœ€å‰é¢ï¼‰=====
        input.addEventListener('input', function() {
            // åªä¿ç•™æ•°å­—ï¼Œè¿‡æ»¤éæ•°å­—å­—ç¬¦
            let val = this.value.replace(/[^0-9]/g, '');
            // å¤„ç†å‰ç½®é›¶ï¼šé•¿åº¦>1ä¸”ä»¥0å¼€å¤´ï¼Œå»æ‰æ‰€æœ‰å‰ç½®é›¶
            if (val.length > 1 && val.startsWith('0')) {
                val = val.replace(/^0+/, '');
                // è‹¥å»æ‰åä¸ºç©ºï¼ˆå¦‚è¾“å…¥0000ï¼‰ï¼Œä¿ç•™ä¸€ä¸ª0
                if (val === '') val = '0';
            }
            // èµ‹å€¼å›è¾“å…¥æ¡†ï¼Œç¡®ä¿è‡³å°‘ä¸º0
            this.value = val || '0';
            
            // åŸæœ‰é€»è¾‘ï¼šæ•°é‡å˜åŒ–æ—¶è®°å½•å¹¶æ˜¾ç¤º
            recordCustomItemQty(this);
        });
                input.addEventListener('input', function() {
                    recordCustomItemQty(this);
                });
                input.addEventListener('change', function() {
                    recordCustomItemQty(this);
                });
                input.addEventListener('blur', function() {
                    recordCustomItemQty(this);
                    resetAllItemsDisplay(); // å¤±ç„¦åå†é‡ç½®ä¸€æ¬¡ï¼ŒåŒé‡ä¿éšœ
                });
            });
        // æ‰¾åˆ°ä¸‹è½½æŒ‰é’®çš„äº‹ä»¶ç»‘å®šï¼Œæ›¿æ¢ä¸ºä»¥ä¸‹ä»£ç 
el.downloadTableBtn = document.getElementById('downloadTableBtn');
el.downloadTableBtn.addEventListener('click', async function() {
    try {
        const table = document.getElementById('materialTable');
        // ç¡®ä¿æœ‰æ•°é‡çš„é…ä»¶æ˜¾ç¤º
        document.querySelectorAll('.qty-input').forEach(input => {
            const qty = parseFloat(input.value) || 0;
            if (qty > 0) input.closest('tr').style.display = 'table-row !important';
        });
        // 1. é«˜æ¸…æˆªå›¾è¡¨æ ¼
        const canvas = await html2canvas(table, {
            scale: 3, // é«˜æ¸…é€‚é…APP
            useCORS: true,
            backgroundColor: '#ffffff'
        });
        // 2. è½¬ä¸ºBlobå¹¶ä¿å­˜åˆ°ç›¸å†Œç›®å½•
        canvas.toBlob(blob => {
            // å…³é”®ï¼šDCIMæ˜¯ç›¸å†Œé»˜è®¤æ‰«æç›®å½•
            const fileName = `DCIM/çŒæº‰ç‰©æ–™æ¸…å•_${new Date().getTime()}.png`;
            saveAs(blob, fileName); // ç”¨FileSaverä¿å­˜åˆ°ç›¸å†Œ
        });
    } catch (err) {
        // å¤±è´¥æç¤ºå·²åˆ é™¤ï¼Œå¦‚éœ€ä¿ç•™å¯æ¢å¤alertè¯­å¥
    }
});
}
        
        // é¡µé¢åˆå§‹åŒ–
        window.onload = function() {
            bindEvents();
            el.nozzleDiameter.disabled = true;
            el.colGap.disabled = true;
            updateNozzleInfo();
            resetAllItemsDisplay(); // åˆå§‹åŒ–æ˜¾ç¤ºè§„åˆ™
            if (el.historyPanel.classList.contains('show')) renderHistoryList();
            initConfigPersistence(); // åˆ·æ–°ä¿å­˜é…ç½®
  initEnterGenerateOnlyInSizeInputs(); // å›è½¦è§¦å‘è®¡ç®—
};
    </script>
</body>
</html>